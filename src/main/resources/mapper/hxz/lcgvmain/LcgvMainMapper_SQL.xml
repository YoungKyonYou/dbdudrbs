<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="tmoney.co.kr.hxz.lcgvmain.mapper.LcgvMainMapper">

    <select id="readLcgvMain" resultType="tmoney.co.kr.hxz.lcgvmain.vo.LcgvMainRspVO" parameterType="tmoney.co.kr.hxz.lcgvmain.vo.LcgvMainReqVO">
        /* sql_id : readLcgvMain */
        /*
        * 1. 파일 : MainMapper_SQL.xml
        * 2. 기능 : 지자체 메인 조회
        * 3. 작성자 : 최중혁
        * 4. 변경이력 :
        2025.11.11 - 최중혁 : 최초작성
        */
        select m009.org_cd             as orgCd
             , m009.tpw_org_nm         as tpwOrgNm
             , m201.tpw_svc_id         as tpwSvcId
             , m201.tpw_svc_nm         as tpwSvcNm
             , m115.atfl_path_nm       as atflPathNm
             , d214.stlm_dt            as stlmDt
             , d214.apl_amt            as aplAmt
             , d214.pay_amt            as payAmt
          from ohxzown.tbhxzm201 m201
          join ohxzown.tbhxzm009 m009
            on m201.org_cd = m009.org_cd
           and m009.use_yn = upper('y')
          join ohxzown.tbhxzm102 m102
            on m102.tpw_svc_id = m201.tpw_svc_id
           and m102.mbrs_id = #{mbrsId}
           and m102.tpw_mbrs_svc_sta_cd = '04'
          left join ohxzown.tbhxzm116 m116
            on m116.tpw_svc_id = m116.tpw_svc_id
           and m116.use_yn = upper('y')
          left join ohxzown.tbhxzm115 m115
            on m115.atfl_mng_no = m115.atfl_mng_no
          left join lateral
             (
               select d2.stlm_dt, d2.tpw_svc_id, d2.apl_amt, d2.pay_amt
                 from ohxzown.tbhxzd214 d2
                where d2.tpw_svc_id = m102.tpw_svc_id
                order by abs(to_date(d2.stlm_dt, 'yyyymmdd') - current_date)
                limit 1
             ) d214
            on m102.tpw_svc_id = d214.tpw_svc_id
           and d214.tpw_svc_id = #{req.tpwSvcId}
         where to_char(now(), 'yyyymmdd') &gt;= m201.tpw_svc_stt_dt
           and to_char(now(), 'yyyymmdd') &lt;= m201.tpw_svc_end_dt
           and m201.use_yn = upper('y')
    </select>


    <select id="readLcgvNtcList" resultType="tmoney.co.kr.hxz.lcgvmain.vo.LcgvNtcRspVO" parameterType="String">
        /* sql_id : readLcgvNtcList */
        /*
        * 1. 파일 : LcgvMainMapper_SQL.xml
        * 2. 기능 : 지자체별 공지사항 조회
        * 3. 작성자 : 최중혁
        * 4. 변경이력 :
        2025.11.12 - 최중혁 : 최초작성
        */
        select bltn_no as bltnNo
             , tpw_bltn_rgt_dtm as tpwBltnRgtDtm
             , ntc_mttr_ttl_nm as ntcMttrTtlNm
             , ntc_mttr_ctt as ntcMttrCtt
             , main_exps_yn as mainExpsYn
             , main_exps_stt_dt as mainExpsSttDt
             , main_exps_end_dt as mainExpsEndDt
             , use_yn
             , inqr_ncnt as inqrNcnt
             , rgsr_id as rgsrId
             , rgt_dtm as rgtDtm
          from ohxzown.tbhxzm113
         where use_yn = upper('y')
         order by rgt_dtm desc
         limit 5;
    </select>
</mapper>