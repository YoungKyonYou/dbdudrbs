<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="tmoney.co.kr.hxz.mypage.cardmng.mapper.CardMngMapper">

    <select id="readCardMng" resultType="tmoney.co.kr.hxz.mypage.cardmng.vo.CardMngRspVO">
        /* sql_id : readCardMng */
        /*
        * 1. 파일 : CardMngMapper_SQL.xml
        * 2. 기능 : 계좌 변경 이력 조회
        * 3. 작성자 : 최중혁
        * 4. 변경이력 :
        2025.11.20 - 최중혁 : 최초작성
        */
        select m201.tpw_svc_id         as tpwSvcId
        , h104.card_mod_dt as cardModDt
        , h104.card_no as cardNo
        , prev.card_no as prevCardNo
        from ohxzown.tbhxzm201 m201
        left join ohxzown.tbhxzm102 m102
        on m102.tpw_svc_id = m201.tpw_svc_id
        and m102.mbrs_id = #{mbrsId}
        join ohxzown.tbhxzh104 h104
        on h104.tpw_svc_id = m201.tpw_svc_id
        and h104.mbrs_id = #{mbrsId}
        left join ohxzown.tbhxzh104 prev
        on prev.tpw_svc_id     = h104.tpw_svc_id
        and prev.tpw_svc_typ_id = h104.tpw_svc_typ_id
        and prev.mbrs_id        = h104.mbrs_id
        and prev.card_mod_sno       = h104.card_mod_sno - 1
        where 1 = 1
        and m201.tpw_svc_id = #{req.tpwSvcId}
        and m201.use_yn = upper('y')
        order by h104.${req.sort} ${req.dir}
        limit #{req.size}
        offset #{req.page}
    </select>

    <select id="readCardMngCnt" resultType="long">
        /* sql_id : readCardMngCnt */
        /*
        * 1. 파일 : CardMngMapper_SQL.xml
        * 2. 기능 : 계좌 관리 내역 카운트 조회
        * 3. 작성자 : 최중혁
        * 4. 변경이력 :
        2025.11.20 - 최중혁 : 최초작성
        */
        select count(1)
        from ohxzown.tbhxzm201 m201
        left join ohxzown.tbhxzm102 m102
        on m102.tpw_svc_id = m201.tpw_svc_id
        and m102.mbrs_id = #{mbrsId}
        join ohxzown.tbhxzh104 h104
        on h104.tpw_svc_id = m201.tpw_svc_id
        and h104.mbrs_id = #{mbrsId}
        where 1 = 1
        and m201.tpw_svc_id = #{req.tpwSvcId}
        and m201.use_yn = upper('y')
    </select>
</mapper>