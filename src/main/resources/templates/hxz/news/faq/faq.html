<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
    <th:block th:fragment="content">

        <!-- Breadcrumb -->
        <div id="breadcrumb">
            <div class="container">
                <nav>
                    <ul>
                        <li>홈</li>
                        <li>소식</li>
                        <li aria-current="page">자주묻는질문</li>
                    </ul>
                </nav>
            </div>
        </div>

        <main id="contents">
            <section class="section" id="grid">
                <div class="container">

                    <!-- 제목 + 검색 -->
                    <div class="title-wrap">
                        <div class="flex justify-space-between">
                            <h2 class="section-title">자주묻는질문</h2>

                            <div id="search-box">
                                <form id="searchbar" th:object="${req}" method="get" role="search">

                                    <div class="dropdown size-lg" role="group" aria-label="검색 구분 선택">
                                        <select id="searchFieldSelect" class="text-field size-lg" aria-label="검색 구분 선택">
                                            <option value="faqTtlNm">제목</option>
                                        </select>
                                        <input type="hidden" id="searchField" name="searchField" value="faqTtlNm">
                                    </div>

                                    <input id="searchInput" class="text-field size-lg" placeholder="검색어를 입력해주세요."
                                        aria-label="검색어" autocomplete="off" enterkeyhint="search">

                                    <button class="btn icon-only size-lg" type="submit" aria-label="검색">
                                        <i class="icon icon-search" aria-hidden="true"></i>
                                    </button>

                                    <!-- VO 필드 hidden -->
                                    <input id="faqTtlNm" th:field="*{faqTtlNm}" type="hidden">
                                    <input id="sort" th:field="*{sort}" type="hidden">
                                    <input id="dir" th:field="*{dir}" type="hidden">
                                    <input id="page" th:field="*{page}" type="hidden" value="0">
                                    <input id="size" th:field="*{size}" type="hidden" value="10">
                                </form>
                            </div>

                        </div>
                    </div>

                    <div class="board-body" id="grid-tbody" role="list" data-behavior="single">
                        <div class="acc-item" th:each="faq, iterStat : ${pageData.content}"
                            th:classappend="${iterStat.index == 0} ? 'is-open'">
                            <h3 class="acc-header">
                                <button type="button" class="acc-trigger"
                                    th:attr="aria-controls='acc-panel-' + ${iterStat.index + 1}"
                                    th:id="'acc-trigger-' + ${iterStat.index + 1}">
                                    <span class="acc-badge" aria-hidden="true">Q</span>
                                    <span class="acc-title" th:text="${faq.faqTtlNm}">FAQ 제목</span>
                                    <span class="acc-icon" aria-hidden="true"></span>
                                </button>
                            </h3>
                            <div class="acc-panel" role="region" th:attr="hidden=${iterStat.index != 0}"
                                style="overflow: hidden; transition: max-height 0.3s ease;">
                                <div class="acc-panel-inner">
                                    <span class="acc-badge" aria-hidden="true">A</span>
                                    <span class="acc-content" th:text="${faq.answCtt}">답변 내용</span>
                                </div>
                            </div>
                        </div>

                        <div class="acc-item" th:if="${pageData == null or #lists.isEmpty(pageData.content)}">
                            <h3 class="acc-header">
                                <span class="acc-title">등록된 FAQ가 없습니다.</span>
                            </h3>
                        </div>
                    </div>

                    <div id="grid-pager" th:if="${pageData != null and pageData.total > 0}">
                        <th:block th:replace="~{component/pagination :: pager(${pageData})}"></th:block>
                    </div>
                </div>
            </section>
        </main>
        <script th:inline="javascript">
            (function () {
                const searchForm = document.getElementById('searchbar');
                const input = document.getElementById('searchInput');
                const titleField = document.getElementById('faqTtlNm');
                const baseUrl = '/news/faq/faq.do';
                const inputSort = document.getElementById('sort');
                const inputDir = document.getElementById('dir');
                const selectSizeInput = document.getElementById('selectSize');

                // 아코디언 바인딩
                function bindAccordion() {
                    const container = document.getElementById('grid-tbody');
                    if (!container) return;

                    container.querySelectorAll('.acc-trigger').forEach(trigger => {
                        const item = trigger.closest('.acc-item');
                        const panel = item.querySelector('.acc-panel');

                        // 초기 상태
                        panel.removeAttribute('hidden');
                        panel.style.maxHeight = item.classList.contains('is-open') ? panel.scrollHeight + 'px' : '0';

                        trigger.addEventListener('click', () => {
                            const isOpen = item.classList.contains('is-open');

                            if (container.dataset.behavior === 'single') {
                                container.querySelectorAll('.acc-item.is-open').forEach(i => {
                                    if (i !== item) {
                                        i.classList.remove('is-open');
                                        i.querySelector('.acc-panel').style.maxHeight = '0';
                                    }
                                });
                            }

                            if (!isOpen) {
                                item.classList.add('is-open');
                                panel.style.maxHeight = panel.scrollHeight + 'px';
                            } else {
                                item.classList.remove('is-open');
                                panel.style.maxHeight = '0';
                            }
                        });
                    });
                }

                // 초기 바인딩
                bindAccordion();

                // 검색폼 제출
                searchForm.addEventListener('submit', e => {
                    e.preventDefault();
                    titleField.value = input.value.trim();
                    const applied = Common.collectFromForm(searchForm);

                    Common.reloadList({
                        page: 0,
                        defaultSortColumn: 'faq_no',
                        swapTargets: ['#grid-tbody', '#grid-pager'],
                        baseUrl,
                        selectSize: selectSizeInput,
                        inputSort,
                        inputDir,
                        applied
                    }).then(() => {
                        document.dispatchEvent(new CustomEvent('gridUpdated'));
                    });
                });

                // 페이지네이션 후 아코디언 재바인딩
                document.addEventListener('gridUpdated', bindAccordion);

                // 페이지네이션 초기 바인딩
                bindPagination(baseUrl, {
                    page: 0,
                    size: parseInt(selectSizeInput?.value || '10', 10),
                    dir: inputDir?.value || 'asc',
                    sort: inputSort?.value || 'rgt_dt'
                });

                // 페이지네이션 클릭 시 gridUpdated 호출
                document.querySelector('#grid-pager')?.addEventListener('click', e => {
                    if (e.target.closest('.pagination a[data-page]')) {
                        setTimeout(() => document.dispatchEvent(new CustomEvent('gridUpdated')), 300);
                    }
                });
            })();
        </script>



    </th:block>
</th:block>

</html>