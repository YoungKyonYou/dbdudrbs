<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
    <th:block th:fragment="content">
        <div id="breadcrumb">
            <div class="container">
                <nav>
                    <ul>
                        <li>홈</li>
                        <li>마이페이지</li>
                        <li aria-current="page">비밀번호 재설정</li>
                    </ul>
                </nav>
            </div>
        </div>

        <main id="contents">
            <section class="section">
                <div class="container size-xsm">
                    <div class="mypage-wrap">
                        <div class="mypage-header">
                            <h2 class="section-title">비밀번호 재설정</h2>
                        </div>
                        <div class="form-box">
                            <!-- th:object 추가 -->
                            <form id="pwdForm" th:object="${mbrsId}" novalidate>
                                <fieldset>
                                    <legend class="sr-only">비밀번호 변경</legend>

                                    <!-- 신규 비밀번호 -->
                                    <div>
                                        <p class="field-title" id="ft-newpw">신규 비밀번호 <span class="color-red">*</span>
                                        </p>
                                        <input type="password" class="text-field size-lg" name="newPassword"
                                            placeholder="비밀번호를 입력해주세요." autocomplete="new-password" minlength="8"
                                            maxlength="20" required aria-required="true" aria-labelledby="ft-newpw"
                                            aria-describedby="pwHelp1 pwHelp2" autocapitalize="off" spellcheck="false"
                                            pattern="^(?=.*[A-Za-z])(?=.*(\d|[^A-Za-z0-9]))[^\s]{8,20}$">
                                        <p class="guide-text" id="pwHelp1">영문은 반드시 포함하고, 숫자 또는 특수문자 중 하나 이상을 함께 사용하여
                                            8~20자로 입력하세요.</p>
                                        <p class="guide-text" id="pwHelp2">아이디가 포함된 비밀번호는 사용하실 수 없습니다.</p>
                                    </div>

                                    <!-- 비밀번호 확인 -->
                                    <div>
                                        <p class="field-title" id="ft-newpw2">비밀번호 확인 <span class="color-red">*</span>
                                        </p>
                                        <input type="password" class="text-field size-lg" name="newPasswordConfirm"
                                            placeholder="비밀번호를 한번 더 입력해주세요." autocomplete="new-password" minlength="8"
                                            maxlength="20" required aria-required="true" aria-labelledby="ft-newpw2"
                                            aria-describedby="pwHelp1b pwHelp2b pwHelp3b pwMismatch"
                                            aria-errormessage="pwMismatch" autocapitalize="off" spellcheck="false"
                                            pattern="^(?=.*[A-Za-z])(?=.*(\d|[^A-Za-z0-9]))[^\s]{8,20}$">
                                        <p class="guide-text" id="pwHelp1b">영문은 반드시 포함하고, 숫자 또는 특수문자 중 하나 이상을 함께 사용하여
                                            8~20자로 입력하세요.</p>
                                        <p class="guide-text" id="pwHelp2b">아이디가 포함된 비밀번호는 사용하실 수 없습니다.</p>
                                        <p class="guide-text" id="pwHelp3b">비밀번호 기입 후 저장하면 비밀번호가 수정됩니다.</p>
                                        <p class="caution-text" id="pwMismatch" role="alert" hidden>입력한 비밀번호가 일치하지 않습니다.
                                        </p>
                                    </div>
                                </fieldset>

                                <div class="btn-wrap">
                                    <button type="button" class="btn btn-darken-line size-lg" id="cancelBtn">취소</button>
                                    <button type="button" class="btn btn-primary size-lg" id="saveBtn">비밀번호 변경</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <script th:inline="javascript" type="text/javascript">
            (function () {
                const form = document.getElementById('pwdForm');
                const cancelBtn = document.getElementById('cancelBtn');
                const saveBtn = document.getElementById('saveBtn');
                const pwInput = form.querySelector('input[name="newPassword"]');
                const pwConfirmInput = form.querySelector('input[name="newPasswordConfirm"]');
                const pwMismatch = document.getElementById('pwMismatch');

                // Thymeleaf에서 mbrsId 가져오기
                const mbrsId = /*[[${mbrsId}]]*/ '';

                // 취소
                cancelBtn.addEventListener('click', () => history.back());

                saveBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    pwMismatch.hidden = true;
                    const newPw = pwInput.value.trim();
                    const confirmPw = pwConfirmInput.value.trim();
                    if (newPw !== confirmPw) {
                        pwMismatch.hidden = false;
                        pwInput.focus();
                        return;
                    }
                    Common.modalShow({
                        title: '알림',
                        message: '비밀번호를 변경하시겠습니까?',
                        buttons: 'ok-close',
                        onOk: async function () {
                            const payload = {
                                newPassword: newPw
                            };

                            const res = await Common.sendSafe(
                                `/mypage/mbrsinf/pwd/${mbrsId}`,
                                'POST',
                                JSON.stringify(payload),
                                undefined,
                                { 'Content-Type': 'application/json' }
                            );

                            if (res && res.ok) {
                                Common.modalShow({
                                    title: '완료',
                                    message: '비밀번호가 변경되었습니다.',
                                    buttons: 'close'
                                });
                                form.reset();
                            }
                        }
                    });
                });
            })();
        </script>

    </th:block>
</th:block>

</html>