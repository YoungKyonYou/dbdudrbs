<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
    <th:block th:fragment="content">
        <div id="breadcrumb">
            <div class="container">
                <nav>
                    <ul>
                        <li>홈</li>
                        <li>마이페이지</li>
                        <li aria-current="page">비밀번호 재설정</li>
                    </ul>
                </nav>
            </div>
        </div>

        <main id="contents">
            <section class="section">
                <div class="container size-xsm">
                    <div class="mypage-wrap">
                        <div class="mypage-header">
                            <h2 class="section-title">비밀번호 재설정</h2>
                        </div>

                        <div class="form-box">
                            <form id="pwdForm" novalidate>
                                <fieldset>
                                    <legend class="sr-only">비밀번호 변경</legend>

                                    <!-- 신규 비밀번호 -->
                                    <div>
                                        <p class="field-title" id="ft-newpw">
                                            신규 비밀번호 <span class="color-red">*</span>
                                        </p>
                                        <input type="password" class="text-field size-lg" name="newPassword"
                                            placeholder="비밀번호를 입력해주세요." autocomplete="new-password" minlength="8"
                                            maxlength="20" required aria-required="true" aria-labelledby="ft-newpw"
                                            aria-describedby="pwHelp1 pwHelp2" autocapitalize="off" spellcheck="false"
                                            pattern="^(?=.*[A-Za-z])(?=.*(\d|[^A-Za-z0-9]))[^\s]{8,20}$">
                                        <p class="guide-text" id="pwHelp1">
                                            영문은 반드시 포함하고, 숫자 또는 특수문자 중 하나 이상을 함께 사용하여 8~20자로 입력하세요.
                                        </p>
                                        <p class="guide-text" id="pwHelp2">
                                            아이디가 포함된 비밀번호는 사용하실 수 없습니다.
                                        </p>
                                    </div>

                                    <!-- 비밀번호 확인 -->
                                    <div>
                                        <p class="field-title" id="ft-newpw2">
                                            비밀번호 확인 <span class="color-red">*</span>
                                        </p>
                                        <input type="password" class="text-field size-lg" name="newPasswordConfirm"
                                            placeholder="비밀번호를 한번 더 입력해주세요." autocomplete="new-password" minlength="8"
                                            maxlength="20" required aria-required="true" aria-labelledby="ft-newpw2"
                                            aria-describedby="pwHelp1b pwHelp2b pwHelp3b pwMismatch"
                                            aria-errormessage="pwMismatch" autocapitalize="off" spellcheck="false"
                                            pattern="^(?=.*[A-Za-z])(?=.*(\d|[^A-Za-z0-9]))[^\s]{8,20}$">
                                        <p class="guide-text" id="pwHelp1b">
                                            영문은 반드시 포함하고, 숫자 또는 특수문자 중 하나 이상을 함께 사용하여 8~20자로 입력하세요.
                                        </p>
                                        <p class="guide-text" id="pwHelp2b">
                                            아이디가 포함된 비밀번호는 사용하실 수 없습니다.
                                        </p>
                                        <p class="guide-text" id="pwHelp3b">
                                            비밀번호 기입 후 저장하면 비밀번호가 수정됩니다.
                                        </p>
                                        <p class="caution-text" id="pwMismatch" role="alert" hidden>
                                            입력한 비밀번호가 일치하지 않습니다.
                                        </p>
                                    </div>
                                </fieldset>

                                <div class="btn-wrap">
                                    <button type="button" class="btn btn-darken-line size-lg" id="cancelBtn">취소</button>
                                    <button type="button" class="btn btn-primary size-lg" id="saveBtn"
                                        th:attr="data-id=${mbrsInf.mbrsId}">비밀번호 변경</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <script th:inline="javascript" type="text/javascript">
            (function () {
                const form = document.getElementById('pwdForm');
                const cancelBtn = document.getElementById('cancelBtn');
                const saveBtn = document.getElementById('saveBtn');
                const pwInput = form.querySelector('input[name="newPassword"]');
                const pwConfirmInput = form.querySelector('input[name="newPasswordConfirm"]');
                const pwMismatch = document.getElementById('pwMismatch');

                cancelBtn.addEventListener('click', () => history.back());

                saveBtn.addEventListener('click', async () => {
                    pwMismatch.hidden = true;

                    const rowId = saveBtn.dataset.id;
                    const newPw = pwInput.value.trim();
                    const confirmPw = pwConfirmInput.value.trim();

                    if (!newPw || !confirmPw) {
                        Common.modalShow({ title: '알림', message: '비밀번호를 모두 입력해주세요.', buttons: 'close' });
                        return;
                    }

                    if (newPw !== confirmPw) {
                        pwMismatch.hidden = false;
                        pwConfirmInput.focus();
                        return;
                    }

                    if (!rowId) {
                        Common.modalShow({ title: '오류', message: '회원 정보가 없습니다. 다시 시도해주세요.', buttons: 'close' });
                        return;
                    }

                    Common.modalShow({
                        title: '알림',
                        message: '비밀번호를 변경하시겠습니까?',
                        buttons: 'ok-close',
                        onOk: async function () {
                            try {
                                const payload = new URLSearchParams();
                                payload.append('newPwd', newPw);
                                payload.append('cfmPwd', confirmPw);

                                const res = await fetch(`/mypage/mbrsinf/pwd/${rowId}`, {
                                    method: 'POST',
                                    headers: {
                                        "Content-Type": "application/x-www-form-urlencoded"
                                    },
                                    body: payload.toString()   // << 꼭 toString() 호출
                                });

                                if (res && (res.ok || res.success)) {
                                    Common.modalShow({
                                        title: '완료',
                                        message: '비밀번호가 변경되었습니다.',
                                        buttons: 'close',
                                        onClose: () => history.back()
                                    });
                                    form.reset();
                                } else {
                                    Common.modalShow({ title: '오류', message: '비밀번호 변경에 실패했습니다. 다시 시도해주세요.', buttons: 'close' });
                                }
                            } catch (err) {
                                console.error(err);
                                Common.modalShow({ title: '오류', message: '요청 중 문제가 발생했습니다.', buttons: 'close' });
                            }
                        }
                    });
                });
            })();
        </script>

    </th:block>
</th:block>

</html>