<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">지원 사업 가입하기</h2>
              <ol class="step-box col3" role="list" aria-label="지원사업 가입 단계">
                <li>
                  <div class="circle"><span>1</span><i class="icon home"></i></div>
                  <p>거주지인증</p>
                </li>
                <li aria-current="step" class="active">
                  <div class="circle"><span>2</span><i class="icon filter"></i></div>
                  <p>인증 및 유형 선택 <span class="sr-only">(현재 단계)</span></p>
                </li>
                <li>
                  <div class="circle"><span>3</span><i class="icon check"></i></div>
                  <p>가입완료</p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-xsm">
          <div class="join-wrap">
            <div class="causion-text">
              <strong>
                <span class="color-secondary">종로구 지역 주민</span>
                <span>만 신청할 수 있습니다.</span>
              </strong>
              <p class="guide-text">
                ※ 행정안전부 행정정보공동이용센터와 연계한 인증으로 이용자가 많을 경우 약 5분 정도 소요됩니다.
              </p>
            </div>

            <div class="form-box">
              <form id="svcJoinForm" enctype="multipart/form-data" novalidate>
                <fieldset>
                  <h3 class="form-title">개인정보</h3>

                  <!-- 카드번호 -->
                  <div>
                    <p class="field-title">카드번호 <span class="color-red">*</span></p>
                    <div class="flex align-center gap8 cardbox">
                      <input id="card-1" class="text-field size-lg" maxlength="4" required>
                      <span class="flex-bar">-</span>
                      <input id="card-2" class="text-field size-lg" maxlength="4" required>
                      <span class="flex-bar">-</span>
                      <input id="card-3" class="text-field size-lg" maxlength="4" required>
                      <span class="flex-bar">-</span>
                      <input id="card-4" class="text-field size-lg" maxlength="4" required>
                      <button type="button" class="btn btn-darkgray size-lg" id="btn-card-check">유효성체크</button>
                    </div>
                  </div>

                  <!-- 은행계좌 -->
                  <div>
                    <p class="field-title">지원금 받을 계좌 <span class="color-red">*</span></p>
                    <div class="flex align-center gap8 bankbox">
                      <div class="dropdown size-lg">
                        <button type="button" id="bankDropdownBtn" class="dropdown_button">
                          <span class="dropdown_value" data-placeholder="은행 선택">은행 선택</span>
                        </button>
                        <ul class="dropdown_list" id="bankDropdownList">
                          <th:block th:each="bank : ${bankList}">
                            <!-- 수정: VO 필드명 반영 -->
                            <li class="dropdown_option" th:data-value="${bank.cmnCd}" th:text="${bank.cmnNm}"></li>
                          </th:block>
                        </ul>
                        <input type="hidden" name="bank">
                      </div>
                      <input type="text" class="text-field size-lg" name="acctNo" placeholder="계좌번호 입력" required>
                      <button class="btn btn-darkgray size-lg" type="button" id="btn-acct-verify">계좌인증</button>
                    </div>
                  </div>

                  <!-- 지원유형 -->
                  <div>
                    <p class="field-title">지원유형 <span class="color-red">*</span></p>
                    <div class="dropdown size-lg">
                      <button type="button" id="supportTypeDropdownBtn" class="dropdown_button">
                        <span class="dropdown_value" data-placeholder="지원유형 선택">유형 선택</span>
                      </button>
                      <ul class="dropdown_list" id="supportTypeDropdownList">
                        <th:block th:each="svc : ${result}">
                          <li class="dropdown_option" th:data-value="${svc.tpwSvcTypId}"
                            th:data-mbrscls="${svc.mbrsClsNm}" th:text="${svc.tpwSvcTypNm}"></li>
                        </th:block>
                      </ul>
                      <input type="hidden" name="tpwSvcTypId">
                      <input type="hidden" name="tpwSvcId" th:value="${result[0].tpwSvcId}">
                    </div>
                  </div>
                </fieldset>

                <!-- 증빙서류 -->
                <fieldset id="evidenceFieldset" style="display:none;">
                  <h3 class="form-title">증빙서류</h3>
                  <div class="file-box" id="evidenceUploader">
                    <input id="evidenceInput" class="file-input" type="file" accept=".jpg,.jpeg,.pdf">
                    <p class="guide-text color-gray">※ 기타 유형은 증빙서류 첨부가 필수입니다.</p>
                  </div>
                </fieldset>

                <div class="btn-wrap">
                  <button type="button" class="btn btn-darken-line size-lg">취소</button>
                  <button type="button" id="btn-submit" class="btn btn-primary size-lg">신청하기</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script th:inline="javascript">
      (function () {
        const form = document.getElementById('svcJoinForm');
        const btnCardCheck = document.getElementById('btn-card-check');
        const btnAcctVerify = document.getElementById('btn-acct-verify');
        const btnSubmit = document.getElementById('btn-submit');
        const supportTypeInput = form.querySelector("input[name='tpwSvcTypId']");
        const evidenceFieldset = document.getElementById('evidenceFieldset');

        let cardValid = false;
        let acctValid = false;
        let selectedMbrsCls = "";

        // ✅ 카드 유효성 체크
        btnCardCheck.addEventListener('click', () => {
          const nums = [1, 2, 3, 4].map(i => form.querySelector(`#card-${i}`).value);
          if (nums.every(v => v.length === 4)) {
            cardValid = true;
            Common.modalShow({ title: '카드 확인', message: '카드번호가 유효합니다.', buttons: 'close' });
            btnCardCheck.classList.replace('btn-darkgray', 'btn-primary');
          } else {
            cardValid = false;
            Common.modalShow({ title: '오류', message: '카드번호를 올바르게 입력해주세요.', buttons: 'close' });
          }
        });

        // ✅ 계좌 인증
        btnAcctVerify.addEventListener('click', () => {
          const bank = form.querySelector("input[name='bank']").value;
          const acctNo = form.querySelector("input[name='acctNo']").value.trim();
          if (!bank || !acctNo) {
            acctValid = false;
            return Common.modalShow({ title: '오류', message: '은행과 계좌번호를 입력해주세요.', buttons: 'close' });
          }
          acctValid = true;
          Common.modalShow({ title: '계좌 인증', message: '계좌 인증이 완료되었습니다.', buttons: 'close' });
          btnAcctVerify.classList.replace('btn-darkgray', 'btn-primary');
        });

        // ✅ 은행 선택
        document.getElementById('bankDropdownList')?.addEventListener('click', (e) => {
          if (e.target.matches('.dropdown_option')) {
            const val = e.target.dataset.value;
            const name = e.target.textContent;
            form.querySelector("input[name='bank']").value = val;
            document.querySelector('#bankDropdownBtn .dropdown_value').textContent = name;
          }
        });

        // ✅ 지원유형 선택 시, 기타 유형이면 파일 필수
        document.getElementById('supportTypeDropdownList')?.addEventListener('click', (e) => {
          if (e.target.matches('.dropdown_option')) {
            const val = e.target.dataset.value;
            const name = e.target.textContent;
            selectedMbrsCls = e.target.dataset.mbrscls;

            supportTypeInput.value = val;
            document.querySelector('#supportTypeDropdownBtn .dropdown_value').textContent = name;

            evidenceFieldset.style.display = selectedMbrsCls === '기타' ? '' : 'none';
          }
        });

        // ✅ 제출
        btnSubmit.addEventListener('click', async () => {
          const cardParts = [1, 2, 3, 4].map(i => form.querySelector(`#card-${i}`).value);

          if (!cardValid) {
            return Common.modalShow({ title: '입력 오류', message: '카드 유효성 체크를 진행해주세요.', buttons: 'close' });
          }
          if (!acctValid) {
            return Common.modalShow({ title: '입력 오류', message: '계좌 인증을 진행해주세요.', buttons: 'close' });
          }
          if (!supportTypeInput.value) {
            return Common.modalShow({ title: '입력 오류', message: '지원유형을 선택해주세요.', buttons: 'close' });
          }
          if (selectedMbrsCls === '기타' && document.getElementById('evidenceInput').files.length === 0) {
            return Common.modalShow({ title: '입력 오류', message: '기타 유형은 증빙서류가 필수입니다.', buttons: 'close' });
          }

          const fd = new FormData();
          const reqData = {
            tpwSvcId: form.querySelector("input[name='tpwSvcId']").value,
            tpwSvcTypId: supportTypeInput.value,
            bankCd: form.querySelector("input[name='bank']").value,
            acctNo: form.querySelector("input[name='acctNo']").value,
            cardNo: cardParts.join('-')
          };

          fd.append("req", new Blob([JSON.stringify(reqData)], { type: "application/json" }));
          fd.append("rsdcInf.rsdcCd", "1101011000");
          fd.append("rsdcInf.orgCd", "JONGNO01");

          const fileInput = document.getElementById('evidenceInput');
          if (fileInput && fileInput.files.length > 0) {
            fd.append("file", fileInput.files[0]);
          }

          try {
            const res = await fetch("/svcjoin/svcJoin", { method: "POST", body: fd });
            if (!res.ok) throw new Error('서버 응답 오류');
            Common.modalShow({ title: '가입 완료', message: '서비스 가입이 완료되었습니다.', buttons: 'close' });
          } catch (e) {
            Common.modalShow({ title: '오류', message: e.message, buttons: 'close' });
          }
        });
      })();
    </script>
  </th:block>
</th:block>

</html>