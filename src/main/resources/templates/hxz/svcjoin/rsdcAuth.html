<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">지원 사업 가입하기</h2>
              <ol class="step-box" role="list" aria-label="지원사업 가입 단계">
                <li aria-current="step" class="active">
                  <div class="circle"><span>1</span><i class="icon home"></i></div>
                  <p>거주지 인증 <span class="sr-only">(현재 단계)</span></p>
                </li>
                <li>
                  <div class="circle"><span>2</span><i class="icon filter"></i></div>
                  <p>유형 선택</p>
                </li>
                <li>
                  <div class="circle"><span>3</span><i class="icon check"></i></div>
                  <p>가입 완료</p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-xsm">
          <div class="join-wrap">
            <!-- 기관 정보 -->
            <div class="causion-text" th:if="${result != null}">
              <strong>
                <span class="color-secondary" th:text="${result.tpwOrgNm != null ? result.tpwOrgNm : '기관명 미확인'}"></span>
                <span> 지역 주민만 신청할 수 있습니다.</span>
              </strong>
              <p class="guide-text">※ 인증 과정은 최대 5분 정도 소요될 수 있습니다.</p>
            </div>
            <div class="causion-text" th:if="${result == null}">
              <strong>
                <span class="color-secondary">기관 정보 없음</span>
                <span> URL 파라미터를 확인해주세요.</span>
              </strong>
              <p class="guide-text">※ orgCd, tpwSvcId 쿼리 파라미터가 필요합니다.</p>
            </div>

            <!-- 거주지 인증 form -->
            <div class="form-box">
              <form id="rsdcAuthForm" method="post" novalidate>
                <fieldset>
                  <legend class="sr-only">주민등록번호 입력</legend>
                  <p class="field-title">주민등록번호</p>

                  <div id="rrnHelp" class="sr-only">앞 6자리와 뒤 7자리를 순서대로 입력하세요.</div>

                  <div class="flex align-center gap8" role="group" aria-describedby="rrnHelp">
                    <label for="rrn1" class="sr-only">앞 6자리</label>
                    <input id="rrn1" name="rrn1" type="text" class="text-field size-lg" placeholder="YYMMDD"
                      inputmode="numeric" maxlength="6" required>
                    <span class="flex-bar" aria-hidden="true">-</span>
                    <label for="rrn2" class="sr-only">뒤 7자리</label>
                    <input id="rrn2" name="rrn2" type="password" class="text-field size-lg" placeholder="*******"
                      inputmode="numeric" maxlength="7" required data-raonsecure="true">
                  </div>

                  <!-- hidden 값 처리 -->
                  <input type="hidden" id="orgCd" name="orgCd" th:value="${result != null ? result.orgCd : ''}">
                  <input type="hidden" id="tpwSvcId" name="tpwSvcId"
                    th:value="${result != null ? result.tpwSvcId : ''}">
                </fieldset>

                <button type="submit" class="btn btn-primary btn-icon-right size-lg">
                  <i class="icon icon-finish" aria-hidden="true"></i>
                  거주지 인증
                </button>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script th:inline="javascript">
      (function () {
        const rrn1 = document.getElementById("rrn1");
        const rrn2 = document.getElementById("rrn2");

        const onlyNumber = e => {
          if (!/[0-9]/.test(e.key) && !["Backspace", "Tab", "ArrowLeft", "ArrowRight", "Delete"].includes(e.key)) {
            e.preventDefault();
          }
        };
        rrn1.addEventListener("keydown", onlyNumber);
        rrn2.addEventListener("keydown", onlyNumber);

        rrn1.addEventListener("input", e => e.target.value = e.target.value.replace(/[^0-9]/g, "").slice(0, 6));
        rrn2.addEventListener("input", e => e.target.value = e.target.value.replace(/[^0-9]/g, "").slice(0, 7));

        const form = document.getElementById("rsdcAuthForm");
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const rrn1Val = rrn1.value.trim();
          const rrn2Val = rrn2.value.trim();
          const orgCd = document.getElementById("orgCd").value;
          const tpwSvcId = document.getElementById("tpwSvcId").value;

          if (!orgCd || !tpwSvcId) {
            Common.modalShow({
              title: '오류',
              message: '기관 정보가 없습니다.<br>URL을 확인해주세요.',
              buttons: 'close'
            });
            return;
          }

          if (!/^\d{6}$/.test(rrn1Val) || !/^\d{7}$/.test(rrn2Val)) {
            Common.modalShow({ title: '입력 오류', message: '주민등록번호를 올바르게 입력해주세요.', buttons: 'close' });
            return;
          }

          const krn = rrn1Val + rrn2Val;
          const reqData = { krn, orgCd, tpwSvcId, addoCd: "1101011000", svcRst: "", declrDate: "" };
          //const reqData = { krn, orgCd, tpwSvcId };

          try {
            const res = await fetch("/svcjoin/rsdcAuth", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(reqData)
            });

            // const data = await Common.sendSafe("/svcjoin/rsdcAuth", {
            //   method: "POST",
            //   data: reqData,
            //   headers: { "Content-Type": "application/json" },
            //   clientErrorMsg: "거주지 인증에 실패했습니다",
            //   otherErrirMSg: "서버 통신 중 문제가 발생했습니다"
            // });

            const data = await res.json().catch(() => ({})); // JSON 파싱 실패 방지용

            console.log(data, '?data')

            // 정상 응답 처리
            if (data.success) {
              Common.modalShow({
                title: '인증 완료',
                message: data.message || '거주지 인증이 완료되었습니다.',
                buttons: 'ok-close',
                onOk: () => location.href = '/svcjoin/svcJoin.do'
              });
            } else {
              Common.modalShow({
                title: '인증 실패',
                message: data?.message || '거주지 인증에 실패했습니다.',
                buttons: 'close'
              });
            }

          } catch (err) {
            console.error('인증 요청 오류:', err);
            Common.modalShow({
              title: '오류',
              message: err?.message || '서버 통신 중 문제가 발생했습니다.<br>잠시 후 다시 시도해주세요.',
              buttons: 'close'
            });
          }

        });
      })();
    </script>


  </th:block>
</th:block>

</html>