<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/layout :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">회원가입</h2>
              <ol class="step-box" role="list" aria-label="회원가입 단계">
                <li>
                  <div class="circle"><span>1</span><i class="icon document"></i></div>
                  <p>약관동의</p>
                </li>
                <li>
                  <div class="circle"><span>2</span><i class="icon lock"></i></div>
                  <p>본인인증</p>
                </li>
                <li aria-current="step" class="active">
                  <div class="circle"><span>3</span><i class="icon write"></i></div>
                  <p>정보입력</p>
                </li>
                <li>
                  <div class="circle"><span>4</span><i class="icon check"></i></div>
                  <p>가입완료</p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-xsm">
          <div class="join-wrap">
            <div class="form-box">
              <form id="joinForm" method="post" data-step="1" action="/etc/mbrsjoin/finalize">
                <!-- 아이디 -->
                <div>
                  <label class="field-title" for="userId">아이디 <span class="color-error">*</span></label>
                  <div class="flex gap8">
                    <input id="userId" name="userId" type="text" class="text-field size-lg" placeholder="아이디를 입력해주세요."
                      minlength="6" maxlength="15" pattern="^[a-z][a-z0-9_]{5,14}$" required
                      aria-describedby="userIdHelp">
                    <button type="button" id="checkIdBtn" class="btn btn-darkgray size-lg">중복확인</button>
                  </div>
                  <p class="guide-text" id="userIdHelp">※ 영문소문자, 숫자, 일부 특수문자(_) 6~15자 (시작은 영문자)</p>
                  <p id="idCheckMsg" class="guide-text" style="margin-top:4px;"></p>
                </div>

                <!-- 비밀번호 -->
                <div>
                  <label class="field-title" for="password">비밀번호 <span class="color-error">*</span></label>
                  <input id="password" name="password" type="password" class="text-field size-lg"
                    placeholder="비밀번호를 입력해주세요." required minlength="8" maxlength="20">
                  <p class="guide-text" id="pwdHelp1">※ 영문, 숫자, 특수문자 중 2가지 이상 혼합 8~20자 (영문자 필수)</p>
                  <p class="guide-text" id="pwdHelp2">※ 아이디가 포함된 비밀번호는 사용할 수 없습니다.</p>
                  <p id="pwdMsg" class="guide-text" style="margin-top:4px;"></p>
                </div>

                <!-- 비밀번호 확인 -->
                <div>
                  <label class="field-title" for="passwordConfirm">비밀번호 확인 <span class="color-error">*</span></label>
                  <input id="passwordConfirm" name="passwordConfirm" type="password" class="text-field size-lg"
                    placeholder="비밀번호를 다시 입력해주세요." required minlength="8" maxlength="20">
                  <p id="pwdConfirmMsg" class="guide-text" style="margin-top:4px;"></p>
                </div>

                <!-- 휴대전화 -->
                <div th:if="${authType eq 'ipin'}">
                  <p class="field-title">휴대전화번호 <span class="color-error">*</span></p>
                  <fieldset>
                    <div class="flex align-center gap8">
                      <input id="mobile1" class="text-field size-lg" name="mobile1" type="text" value="010">
                      <span class="flex-bar">-</span>
                      <input id="mobile2" class="text-field size-lg" name="mobile2" type="text" value="1234">
                      <span class="flex-bar">-</span>
                      <input id="mobile3" class="text-field size-lg" name="mobile3" type="text" value="5678">
                    </div>
                  </fieldset>
                </div>

                <!-- 전화번호 -->
                <div>
                  <p class="field-title">전화번호 (선택)</p>
                  <fieldset>
                    <div class="flex align-center gap8">
                      <input id="tel1" type="text" class="text-field size-lg" placeholder="02" inputmode="numeric">
                      <span class="flex-bar">-</span>
                      <input id="tel2" type="text" class="text-field size-lg" placeholder="1234" inputmode="numeric">
                      <span class="flex-bar">-</span>
                      <input id="tel3" type="text" class="text-field size-lg" placeholder="5678" inputmode="numeric">
                    </div>
                  </fieldset>
                </div>

                <!-- 이메일 -->
                <div>
                  <label class="field-title" for="emailId">이메일 (선택)</label>
                  <div class="flex align-center gap8">
                    <input id="emailId" type="text" class="text-field size-lg" placeholder="아이디">
                    <span class="flex-bar">@</span>
                    <input id="emailDomainManual" type="text" class="text-field size-lg" placeholder="도메인 직접 입력">
                  </div>
                </div>
                <div>
                  <div class="control checkbox">
                    <input type="checkbox" id="check-arg-1" name="marketing-collect" value="Y">
                    <label for="check-arg-1">
                      <span class="color-primary">[선택]</span> 마케팅 목적의 개인정보 수집 및 이용 동의
                    </label>
                  </div>

                  <!-- 광고성 정보 수신 동의 -->
                  <fieldset class="control-group checkbox-group vertical">
                    <legend class="field-title">광고성 정보 수신 동의</legend>

                    <!-- 전체선택 -->
                    <div class="control checkbox">
                      <input type="checkbox" id="chk-all" class="chk-all">
                      <label for="chk-all">
                        <span class="color-primary">[선택]</span> 광고성 정보 수신 동의
                      </label>
                    </div>

                    <div class="depth2">
                      <!-- 하위 항목 -->
                      <div class="control checkbox">
                        <input type="checkbox" id="chk-email" class="chk-item" name="ad-receive[]" value="email"
                          aria-describedby="adReceiveHelp">
                        <label for="chk-email">이메일 수신 동의</label>
                      </div>

                      <div class="control checkbox">
                        <input type="checkbox" id="chk-sms" class="chk-item" name="ad-receive[]" value="sms"
                          aria-describedby="adReceiveHelp">
                        <label for="chk-sms">SMS, SNS 수신 동의</label>
                      </div>
                    </div>
                    <p id="adReceiveHelp" class="guide-text">언제든 설정에서 수신 여부를 변경할 수 있습니다.</p>
                  </fieldset>

                </div>

                <button type="submit" class="btn btn-primary size-lg">완료</button>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script th:inline="javascript">
      (function () {
        const step0 = sessionStorage.getItem('step0');
        const step0Obj = JSON.parse(step0 || '{}');   // step0
        const rcpt0 = sessionStorage.getItem('rcpt0');
        if (!step0 || !rcpt0) {
          Common.modalShow({
            title: '알림',
            message: '이전 단계 정보가 누락되었습니다. Step1부터 진행해주세요.',
            buttons: 'close'
          });
          Common.MiniSPA.go('/etc/mbrsjoin/step1.do');
          return;
        }

        const form = document.getElementById('joinForm');
        const userId = document.getElementById('userId');
        const checkBtn = document.getElementById('checkIdBtn');
        const idMsg = document.getElementById('idCheckMsg');
        const pwd = document.getElementById('password');
        const pwdConfirm = document.getElementById('passwordConfirm');
        const pwdMsg = document.getElementById('pwdMsg');
        const pwdConfirmMsg = document.getElementById('pwdConfirmMsg');

        const mrkgUtlzAgrmYn = document.getElementById('check-arg-1')?.checked ? 'Y' : 'N';
        const mailRcvAgrmYn = document.getElementById('chk-email')?.checked ? 'Y' : 'N';
        const smsRcvAgrmYn = document.getElementById('chk-sms')?.checked ? 'Y' : 'N';
        const ntfcYn = (mailRcvAgrmYn === 'Y' || smsRcvAgrmYn === 'Y') ? 'Y' : 'N';
        let idChecked = false;
        let sending = false;

        const clone = obj => { try { return structuredClone(obj); } catch { return JSON.parse(JSON.stringify(obj || {})); } };

        function saveReceipt(step, receipt) { if (receipt) sessionStorage.setItem('rcpt' + step, receipt); }
        function saveStepPayload(step, payload) { if (payload) sessionStorage.setItem('step' + step, JSON.stringify(payload)); }

        userId.addEventListener('input', () => { idChecked = false; idMsg.textContent = ''; });

        checkBtn.addEventListener('click', async () => {
          const idValue = userId.value.trim();
          const idPattern = /^[a-z][a-z0-9_]{5,14}$/;

          // 아이디 형식 검증
          if (!idPattern.test(idValue)) {
            if (idMsg) idMsg.textContent = '❌ 아이디 형식이 올바르지 않습니다. (영문 소문자로 시작, 6~15자)';
            Common.modalShow({
              title: '알림',
              message: '❌ 아이디 형식이 올바르지 않습니다. (영문 소문자로 시작, 6~15자)',
              buttons: 'close'
            });
            return;
          }

          try {
            const res = await Common.sendSafe('/etc/mbrsjoin/checkId', {
              method: 'POST',
              data: { mbrsId: idValue },
              expect: 'text'
            });

            const text = res?.data || '';
            idChecked = text.includes('사용 가능한');
            if (idChecked) {
              if (idMsg) idMsg.textContent = '✅ 사용 가능한 아이디입니다.';
              Common.modalShow({
                title: '사용 가능',
                message: '✅ 사용 가능한 아이디입니다.',
                buttons: 'close'
              });
            } else {
              if (idMsg) idMsg.textContent = '❌ 이미 사용 중인 아이디입니다.';
              Common.modalShow({
                title: '사용 불가',
                message: '❌ 이미 사용 중인 아이디입니다.',
                buttons: 'close'
              });
            }

          } catch (err) {
            if (idMsg) idMsg.textContent = '❌ 서버 오류로 확인에 실패했습니다.';
            Common.modalShow({
              title: '오류',
              message: '❌ 서버 오류로 아이디 확인에 실패했습니다.',
              buttons: 'close'
            });
          }
        });


        function checkPassword() {
          const pass = pwd.value.trim();
          const confirm = pwdConfirm.value.trim();
          const idValue = userId.value.trim();
          const pwdPattern = /^(?=.*[a-zA-Z])(?:(?=.*\d)|(?=.*[!@#$%^&*?_~]))[A-Za-z\d!@#$%^&*?_~]{8,20}$/;
          if (!pwdPattern.test(pass)) { pwdMsg.textContent = '❌ 비밀번호 조건 불일치'; pwdConfirmMsg.textContent = ''; return false; }
          if (idValue && pass.toLowerCase().includes(idValue.toLowerCase())) { pwdMsg.textContent = '❌ 비밀번호에 아이디 포함 불가'; pwdConfirmMsg.textContent = ''; return false; }
          pwdMsg.textContent = '✅ 사용 가능';
          pwdConfirmMsg.textContent = pass === confirm ? '✅ 비밀번호 일치' : '❌ 비밀번호 불일치';


          return pass === confirm;
        }

        pwd.addEventListener('input', checkPassword);
        pwdConfirm.addEventListener('input', checkPassword);

        async function submitStep3(form) {
          if (sending) return;
          sending = true;
          form.classList.add('dim');

          const mobile = [document.getElementById('mobile1')?.value || '', document.getElementById('mobile2')?.value || '', document.getElementById('mobile3')?.value || ''].join('');
          const tel = [document.getElementById('tel1')?.value || '', document.getElementById('tel2')?.value || '', document.getElementById('tel3')?.value || ''].join('');
          const email = (document.getElementById('emailId')?.value || '') + (document.getElementById('emailDomainManual')?.value || '');

          const body = {
            mbrsId: userId.value.trim(),
            pwd: pwd.value.trim(),
            cfmPwd: pwdConfirm.value.trim(),
            mbrsMbphNo: '01012345678',
            mbrsTelNo: '021234567',
            mailAddr: email,

            mrkgUtlzAgrmYn,
            smsRcvAgrmYn,
            mailRcvAgrmYn
          };

          const headers = { 'X-Nonce': step0Obj.nextNonce };


          try {
            // Step3 서버 호출
            const step3Res = await Common.sendSafe('/etc/mbrsjoin/step3/complete', { method: 'POST', data: body, headers, expect: 'json' });
            if (!step3Res || step3Res.ok === false) { sending = false; form.classList.remove('dim'); return; }
            saveReceipt(1, step3Res.data.receipt || step3Res.data.rcpt || null);
            saveStepPayload(1, clone(body));
            const step1Str = sessionStorage.getItem('step1');
            const step1Obj = JSON.parse(step1Str || '{}');

            const payload = {
              step0: step0Obj.payload,   // ✅ 객체로 변환
              step1: step1Obj,   // ✅ 객체로 변환
              rcpt0: rcpt0,
              rcpt1: sessionStorage.getItem('rcpt1')
            };
            const finalizeRes = await Common.sendSafe(form.getAttribute('action'), { method: 'POST', data: payload, headers, expect: 'json' });
            if (!finalizeRes || finalizeRes.ok === false) { sending = false; form.classList.remove('dim'); return; }

            Common.MiniSPA.go('/etc/mbrsjoin/step4.do');
          } catch (e) {
            alert('❌ 서버 요청 실패: ' + (e?.message || e));
          } finally {
            sending = false;
            form.classList.remove('dim');
          }
        }

        form.addEventListener('submit', async e => {
          e.preventDefault();
          const idPattern = /^[a-z][a-z0-9_]{5,14}$/;
          if (!idPattern.test(userId.value.trim())) { Common.modalShow({ title: '알림', message: '아이디 형식이 올바르지 않습니다.', buttons: 'close' }); return; }
          if (!idChecked) { Common.modalShow({ title: '알림', message: '아이디 중복 확인이 필요합니다.', buttons: 'close' }); return; }
          if (pwd.value.length < 8 || pwd.value.length > 20) {
            Common.modalShow({
              title: '알림',
              message: '비밀번호는 8~20자여야 합니다.',
              buttons: 'close'
            });
            return false;
          }
          if (pwd.value !== pwdConfirm.value) {
            Common.modalShow({
              title: '알림',
              message: '비밀번호가 일치하지 않습니다.',
              buttons: 'close'
            });
            return false;
          }
          if (!checkPassword()) return;
          await submitStep3(form);
        });

      })();
    </script>

  </th:block>
</th:block>

</html>