<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">회원가입</h2>
              <ol class="step-box" role="list" aria-label="회원가입 단계">
                <li>
                  <div class="circle"><span>1</span><i class="icon document"></i></div>
                  <p>약관동의</p>
                </li>
                <li>
                  <div class="circle"><span>2</span><i class="icon lock"></i></div>
                  <p>본인인증</p>
                </li>
                <li aria-current="step" class="active">
                  <div class="circle"><span>3</span><i class="icon write"></i></div>
                  <p>정보입력</p>
                </li>
                <li>
                  <div class="circle"><span>4</span><i class="icon check"></i></div>
                  <p>가입완료</p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-xsm">
          <div class="join-wrap">
            <div class="form-box">
              <form id="joinForm" method="post" novalidate>
                <!-- 아이디 -->
                <div>
                  <label class="field-title" for="userId">아이디 <span class="color-error">*</span></label>
                  <div class="flex gap8">
                    <input id="userId" name="userId" type="text" class="text-field size-lg" placeholder="아이디를 입력해주세요."
                      minlength="6" maxlength="15" pattern="^[a-z][a-z0-9_]{5,14}$" required
                      aria-describedby="userIdHelp">
                    <button type="button" id="checkIdBtn" class="btn btn-darkgray size-lg">중복확인</button>
                  </div>
                  <p class="guide-text" id="userIdHelp">※ 영문소문자, 숫자, 일부 특수문자(_) 6~15자 (시작은 영문자)</p>
                  <p id="idCheckMsg" class="guide-text" style="margin-top:4px;"></p>
                </div>

                <!-- 비밀번호 -->
                <div>
                  <label class="field-title" for="password">비밀번호 <span class="color-error">*</span></label>
                  <input id="password" name="password" type="password" class="text-field size-lg"
                    placeholder="비밀번호를 입력해주세요." required minlength="8" maxlength="20">
                  <p class="guide-text" id="pwdHelp1">※ 영문, 숫자, 특수문자 중 2가지 이상 혼합 8~20자 (영문자 필수)</p>
                  <p class="guide-text" id="pwdHelp2">※ 아이디가 포함된 비밀번호는 사용할 수 없습니다.</p>
                  <p id="pwdMsg" class="guide-text" style="margin-top:4px;"></p>
                </div>

                <!-- 비밀번호 확인 -->
                <div>
                  <label class="field-title" for="passwordConfirm">비밀번호 확인 <span class="color-error">*</span></label>
                  <input id="passwordConfirm" name="passwordConfirm" type="password" class="text-field size-lg"
                    placeholder="비밀번호를 다시 입력해주세요." required minlength="8" maxlength="20">
                  <p id="pwdConfirmMsg" class="guide-text" style="margin-top:4px;"></p>
                </div>

                <!-- 전화번호 -->
                <div>
                  <p class="field-title">전화번호 (선택)</p>
                  <fieldset>
                    <div class="flex align-center gap8">
                      <input id="tel1" type="text" class="text-field size-lg" placeholder="02" inputmode="numeric">
                      <span class="flex-bar">-</span>
                      <input id="tel2" type="text" class="text-field size-lg" placeholder="1234" inputmode="numeric">
                      <span class="flex-bar">-</span>
                      <input id="tel3" type="text" class="text-field size-lg" placeholder="5678" inputmode="numeric">
                    </div>
                  </fieldset>
                </div>

                <!-- 이메일 -->
                <div>
                  <label class="field-title" for="emailId">이메일 (선택)</label>
                  <div class="flex align-center gap8">
                    <input id="emailId" type="text" class="text-field size-lg" placeholder="아이디">
                    <span class="flex-bar">@</span>
                    <input id="emailDomainManual" type="text" class="text-field size-lg" placeholder="도메인 직접 입력">
                  </div>
                </div>

                <button type="submit" class="btn btn-primary size-lg">완료</button>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function () {
        // 1. 이전 단계 확인
        const step0 = sessionStorage.getItem('step0');
        const rcpt0 = sessionStorage.getItem('rcpt0');
        if (!step0 || !rcpt0) {
          alert('이전 단계 정보가 누락되었습니다. Step1부터 진행해주세요.');
          location.href = '/etc/mbrsjoin/step1.do';
          return;
        }

        const form = document.getElementById('joinForm');
        const userId = document.getElementById('userId');
        const checkBtn = document.getElementById('checkIdBtn');
        const idMsg = document.getElementById('idCheckMsg');
        const pwd = document.getElementById('password');
        const pwdConfirm = document.getElementById('passwordConfirm');
        const pwdMsg = document.getElementById('pwdMsg');
        const pwdConfirmMsg = document.getElementById('pwdConfirmMsg');

        let idChecked = false;

        // 2. 아이디 체크
        userId.addEventListener('input', () => { idChecked = false; });

        checkBtn.addEventListener('click', async () => {
          const idValue = userId.value.trim();
          if (!/^[a-z][a-z0-9_]{5,14}$/.test(idValue)) return;
          const res = await fetch('/etc/mbrsjoin/checkId', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mbrsId: idValue })
          });
          const text = await res.text();
          if (text.includes('사용 가능한')) { idChecked = true; idMsg.textContent = '✅ 사용 가능'; }
          else { idChecked = false; idMsg.textContent = '❌ 이미 사용 중'; }
        });

        // 3. 비밀번호 체크
        function checkPassword() {
          const pass = pwd.value.trim();
          const confirm = pwdConfirm.value.trim();
          const idValue = userId.value.trim();

          if (!/^(?=.*[a-zA-Z])(?:(?=.*\d)|(?=.*[!@#$%^&*?_~]))[A-Za-z\d!@#$%^&*?_~]{8,20}$/.test(pass)) {
            pwdMsg.textContent = '❌ 비밀번호 조건 불일치'; return;
          }
          if (idValue && pass.toLowerCase().includes(idValue.toLowerCase())) {
            pwdMsg.textContent = '❌ 비밀번호에 아이디 포함'; return;
          }
          pwdMsg.textContent = '✅ 사용 가능';

          pwdConfirmMsg.textContent = pass === confirm ? '✅ 비밀번호 일치' : '❌ 불일치';
        }
        pwd.addEventListener('input', checkPassword);
        pwdConfirm.addEventListener('input', checkPassword);

        // 4. 폼 제출
        form.addEventListener('submit', async e => {
          e.preventDefault();
          if (!idChecked) { alert('아이디 중복확인 필요'); return; }

          const postData = {
            mbrsId: userId.value.trim(),
            pwd: pwd.value.trim(),
            cfmPwd: pwdConfirm.value.trim(),
            mrkgUtlzAgrmYn: sessionStorage.getItem('mrkgUtlzAgrmYn') || 'N',
            smsRcvAgrmYn: sessionStorage.getItem('smsRcvAgrmYn') || 'N',
            mailRcvAgrmYn: sessionStorage.getItem('mailRcvAgrmYn') || 'N',
          };

          try {
            const res = await fetch('/etc/mbrsjoin/step3/complete', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Nonce': step0  // ✅ precheck 통과를 위한 nonce
              },
              body: JSON.stringify(postData),
              credentials: 'include'
            });
            const data = await res.json();
            sessionStorage.setItem('rcpt3', data.receipt);
            sessionStorage.setItem('step3', JSON.stringify(postData));
            alert('회원정보 입력 완료!');
            location.href = '/etc/mbrsjoin/step4.do';
          } catch (err) {
            alert('❌ 서버 요청 실패: ' + err.message);
          }
        });

      })();


    </script>



  </th:block>
</th:block>

</html>