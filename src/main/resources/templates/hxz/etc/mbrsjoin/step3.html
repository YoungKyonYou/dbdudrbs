<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">회원가입</h2>
              <ol class="step-box" role="list" aria-label="회원가입 단계">
                <li>
                  <div class="circle"><span>1</span><i class="icon document"></i></div>
                  <p>약관동의</p>
                </li>
                <li>
                  <div class="circle"><span>2</span><i class="icon lock"></i></div>
                  <p>본인인증</p>
                </li>
                <li aria-current="step" class="active">
                  <div class="circle"><span>3</span><i class="icon write"></i></div>
                  <p>정보입력</p>
                </li>
                <li>
                  <div class="circle"><span>4</span><i class="icon check"></i></div>
                  <p>가입완료</p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-xsm">
          <div class="join-wrap">
            <div class="form-box">
              <form id="joinForm" method="post" novalidate>

                <!-- 아이디 -->
                <div>
                  <label class="field-title" for="userId">아이디 <span class="color-error">*</span></label>
                  <div class="flex gap8">
                    <input id="userId" name="userId" type="text" class="text-field size-lg" placeholder="아이디를 입력해주세요."
                      minlength="6" maxlength="15" pattern="^[a-z][a-z0-9_]{5,14}$" required
                      aria-describedby="userIdHelp">
                    <button type="button" id="checkIdBtn" class="btn btn-darkgray size-lg">중복확인</button>
                  </div>
                  <p class="guide-text" id="userIdHelp">※ 영문소문자, 숫자, 일부 특수문자(_) 6~15자 (시작은 영문자)</p>
                  <p id="idCheckMsg" class="guide-text" style="margin-top:4px;"></p>
                </div>

                <!-- 비밀번호 -->
                <div>
                  <label class="field-title" for="password">비밀번호 <span class="color-error">*</span></label>
                  <input id="password" name="password" type="password" class="text-field size-lg"
                    placeholder="비밀번호를 입력해주세요." required minlength="8" maxlength="20">
                  <p class="guide-text" id="pwdHelp1">※ 영문, 숫자, 특수문자 중 2가지 이상 혼합 8~20자 (영문자 필수)</p>
                  <p class="guide-text" id="pwdHelp2">※ 아이디가 포함된 비밀번호는 사용할 수 없습니다.</p>
                  <p id="pwdMsg" class="guide-text" style="margin-top:4px;"></p>
                </div>

                <!-- 비밀번호 확인 -->
                <div>
                  <label class="field-title" for="passwordConfirm">비밀번호 확인 <span class="color-error">*</span></label>
                  <input id="passwordConfirm" name="passwordConfirm" type="password" class="text-field size-lg"
                    placeholder="비밀번호를 다시 입력해주세요." required minlength="8" maxlength="20">
                </div>

                <!-- 휴대전화번호 -->
                <div>
                  <p class="field-title">휴대전화번호 <span class="color-error">*</span></p>
                  <fieldset>
                    <legend class="sr-only">휴대전화번호</legend>
                    <div class="flex align-center gap8">
                      <input id="mobile1" type="text" class="text-field size-lg" value="010" readonly>
                      <span class="flex-bar">-</span>
                      <input id="mobile2" type="text" class="text-field size-lg" placeholder="1234" inputmode="numeric">
                      <span class="flex-bar">-</span>
                      <input id="mobile3" type="text" class="text-field size-lg" placeholder="5678" inputmode="numeric">
                    </div>
                  </fieldset>
                </div>

                <!-- 전화번호 -->
                <div>
                  <p class="field-title">전화번호 (선택)</p>
                  <fieldset>
                    <div class="flex align-center gap8">
                      <input id="tel1" type="text" class="text-field size-lg" placeholder="02" inputmode="numeric">
                      <span class="flex-bar">-</span>
                      <input id="tel2" type="text" class="text-field size-lg" placeholder="1234" inputmode="numeric">
                      <span class="flex-bar">-</span>
                      <input id="tel3" type="text" class="text-field size-lg" placeholder="5678" inputmode="numeric">
                    </div>
                  </fieldset>
                </div>

                <!-- 이메일 -->
                <div>
                  <label class="field-title" for="emailId">이메일 (선택)</label>
                  <div class="flex align-center gap8">
                    <input id="emailId" type="text" class="text-field size-lg" placeholder="아이디">
                    <span class="flex-bar">@</span>
                    <input id="emailDomainManual" type="text" class="text-field size-lg" placeholder="도메인 직접 입력">
                  </div>
                </div>

                <button type="submit" class="btn btn-primary size-lg">완료</button>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>
    <script>
      (function () {
        const userId = document.getElementById('userId');
        const checkBtn = document.getElementById('checkIdBtn');
        const idMsg = document.getElementById('idCheckMsg');
        const form = document.getElementById('joinForm');
        const pwd = document.getElementById('password');
        const pwdConfirm = document.getElementById('passwordConfirm');
        const pwdMsg = document.getElementById('pwdMsg');

        const pwdConfirmMsg = document.createElement('p');
        pwdConfirmMsg.id = 'pwdConfirmMsg';
        pwdConfirmMsg.className = 'guide-text';
        pwdConfirmMsg.style.marginTop = '4px';
        pwdConfirm.insertAdjacentElement('afterend', pwdConfirmMsg);

        let idChecked = false;
        const idRegex = /^[a-z][a-z0-9_]{5,14}$/;
        const pwdRegex = /^(?=.*[a-zA-Z])(?:(?=.*\d)|(?=.*[^a-zA-Z0-9])).{8,20}$/;
        const contextPath = ''; // 필요 시 수정

        /** 아이디 입력 시 초기화 */
        userId.addEventListener('input', () => {
          idChecked = false;
          idMsg.textContent = '';
          idMsg.style.color = '';
        });

        /** 아이디 중복 확인 */
        checkBtn.addEventListener('click', async () => {
          const id = userId.value.trim();
          idChecked = false;
          idMsg.textContent = '';
          idMsg.style.color = '';

          if (!idRegex.test(id)) {
            idMsg.textContent = "❌ 아이디 규칙 불일치";
            idMsg.style.color = "red";
            return;
          }

          // 객체 그대로 전달 (send에서 JSON.stringify 처리)
          const postData = { mbrsId: id };

          const res = await Common.sendSafe(
            `${contextPath}/etc/mbrsjoin/checkId`,
            'POST',
            postData,
            undefined,
            { 'Content-Type': 'application/json' },

          );

          if (!res) return; // 요청 취소

          if (res.ok) {
            idMsg.textContent = res.data || "✅ 사용 가능한 아이디입니다.";
            idMsg.style.color = "green";
            idChecked = true;
          } else {
            idMsg.textContent = res.data || "❌ 아이디 확인 실패";
            idMsg.style.color = "red";
          }
        });

        /** 비밀번호 체크 */
        function checkPassword() {
          const password = pwd.value.trim();
          const idValue = userId.value.trim();

          if (!pwdRegex.test(password)) {
            pwdMsg.textContent = "❌ 비밀번호 형식이 올바르지 않습니다.";
            pwdMsg.style.color = "red";
          } else if (idValue && password.includes(idValue)) {
            pwdMsg.textContent = "❌ 비밀번호에 아이디 포함 불가";
            pwdMsg.style.color = "red";
          } else {
            pwdMsg.textContent = "✅ 사용 가능한 비밀번호입니다.";
            pwdMsg.style.color = "green";
          }
          checkPasswordMatch();
        }

        function checkPasswordMatch() {
          const password = pwd.value.trim();
          const confirm = pwdConfirm.value.trim();

          if (!confirm) {
            pwdConfirmMsg.textContent = "";
            return;
          }

          if (password === confirm) {
            pwdConfirmMsg.textContent = "✅ 비밀번호가 일치합니다.";
            pwdConfirmMsg.style.color = "green";
          } else {
            pwdConfirmMsg.textContent = "❌ 비밀번호가 일치하지 않습니다.";
            pwdConfirmMsg.style.color = "red";
          }
        }

        pwd.addEventListener('input', checkPassword);
        pwdConfirm.addEventListener('input', checkPasswordMatch);

        /** 숫자만 입력 */
        ['mobile2', 'mobile3', 'tel1', 'tel2', 'tel3'].forEach(id => {
          const field = document.getElementById(id);
          field.addEventListener('input', () => {
            field.value = field.value.replace(/[^0-9]/g, '');
          });
        });

        /** 폼 제출 */
        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          const id = userId.value.trim();
          const password = pwd.value.trim();
          const confirm = pwdConfirm.value.trim();
          const m2 = document.getElementById('mobile2').value.trim();
          const m3 = document.getElementById('mobile3').value.trim();
          const tel1 = document.getElementById('tel1').value.trim();
          const tel2 = document.getElementById('tel2').value.trim();
          const tel3 = document.getElementById('tel3').value.trim();
          const emailId = document.getElementById('emailId').value.trim();
          const emailDomain = document.getElementById('emailDomainManual').value.trim();

          if (!id) { alert("아이디 입력"); userId.focus(); return; }
          if (!idChecked) { alert("아이디 중복 확인"); return; }
          if (!password) { alert("비밀번호 입력"); pwd.focus(); return; }
          if (!pwdRegex.test(password)) { alert("비밀번호 형식 오류"); pwd.focus(); return; }
          if (password.includes(id)) { alert("비밀번호에 아이디 포함 불가"); pwd.focus(); return; }
          if (password !== confirm) { alert("비밀번호 불일치"); pwdConfirm.focus(); return; }
          if (!m2 || !m3) { alert("휴대전화번호 입력"); return; }

          // 객체 그대로 전달
          const postData = {
            mbrsId: id,
            password,
            mobile: `010-${m2}-${m3}`,
            tel: (tel1 && tel2 && tel3) ? `${tel1}-${tel2}-${tel3}` : '',
            email: (emailId && emailDomain) ? `${emailId}@${emailDomain}` : ''
          };

          const res = await Common.sendSafe(
            `${contextPath}/etc/mbrsjoin/step4`,
            'POST',
            postData,
            undefined,
            { 'Content-Type': 'application/json' },
            'json',
            '회원가입 요청 실패',
            '서버 오류가 발생했습니다.'
          );

          if (res && res.ok) {
            alert("✅ 회원가입 완료!");
            window.location.href = `${contextPath}/etc/mbrsjoin/step4.do`;
          } else if (res && !res.ok) {
            alert(res.data || "❌ 회원가입 실패");
          }
        });
      })();
    </script>










  </th:block>
</th:block>

</html>