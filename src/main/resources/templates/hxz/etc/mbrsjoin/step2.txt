<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/layout :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">회원가입</h2>
              <ol class="step-box" role="list" aria-label="회원가입 단계">
                <li>
                  <div class="circle"><span>1</span><i class="icon document"></i></div>
                  <p>약관동의</p>
                </li>
                <li aria-current="step" class="active">
                  <div class="circle"><span>2</span><i class="icon lock"></i></div>
                  <p>본인인증</p>
                </li>
                <li>
                  <div class="circle"><span>3</span><i class="icon write"></i></div>
                  <p>정보입력</p>
                </li>
                <li>
                  <div class="circle"><span>4</span><i class="icon check"></i></div>
                  <p>가입완료</p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-sm">
          <div class="join-wrap">
            <!-- form: step2 인증 -->
            <form id="step2Form" class="step-form" data-step="0" action="/etc/mbrsjoin/step2/complete" method="POST">
              <!-- nonce hidden -->
              <input type="hidden" name="nonce" th:value="${signup.nonce}" />

              <div class="gray-outer">
                <div class="step2-box" role="group" aria-label="본인인증 수단 선택">
                  <button type="button" class="auth-btn kakao" data-method="kakao">
                    <i class="icon" aria-hidden="true"></i>
                    <span>카카오뱅크 인증</span>
                  </button>

                  <button type="button" class="auth-btn toss" data-method="toss">
                    <i class="icon" aria-hidden="true"></i>
                    <span>토스 인증</span>
                  </button>

                  <button type="button" class="auth-btn phone" data-method="phone">
                    <i class="icon" aria-hidden="true"></i>
                    <span>휴대폰 인증</span>
                  </button>

                  <button type="button" class="auth-btn ipin" data-method="ipin">
                    <i class="icon" aria-hidden="true"></i>
                    <span>아이핀 인증</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>

    <script th:inline="javascript">
      (function () {
        let sending = false;

        function saveReceipt(step, receipt) {
          if (receipt) sessionStorage.setItem('rcpt' + step, receipt);
        }

        function saveStepPayload(step, payload) {
          if (payload) sessionStorage.setItem('step' + step, JSON.stringify(payload));
        }

        async function submitStep2(form, authMethod) {
          if (sending) return;
          sending = true;
          form.classList.add('dim');

          const nonceInput = form.querySelector('input[name="nonce"]');
          const nonce = nonceInput ? nonceInput.value : '';
          const body = new FormData();
          body.append('authType', authMethod);

          const headers = { 'X-Nonce': nonce };

          try {
            const out = await Common.sendSafe(
              form.getAttribute('action'),
              { method: 'POST', data: body, headers, expect: 'json' }
            );

            if (!out || out.ok === false) return;

            const step = parseInt(form.getAttribute('data-step'), 10);
            const payloadRaw = out.data?.payload;

            let payloadParsed = null;

            if (payloadRaw && typeof payloadRaw === 'string') {
              try {
                const jsonStr = payloadRaw
                  .replace(/^[^{]*\(/, '{')
                  .replace(/\)$/, '}')
                  .replace(/(\w+)=/g, '"$1":')
                  .replace(/, /g, ',')
                  .replace(/'/g, '"');

                payloadParsed = JSON.parse(jsonStr);
              } catch (err) {
                console.warn('⚠️ payload 파싱 실패:', err);
                payloadParsed = { raw: payloadRaw };
              }
            }

            saveStepPayload(step, {
              ...out.data,
              payload: payloadParsed || payloadRaw
            });
            saveReceipt(step, out.data.receipt || out.data.rcpt || null);


            if (out.data.nextNonce) {
              const nextForm = document.querySelector(`form.step-form[data-step="${step + 1}"]`);
              if (nextForm) {
                const nextNonceInput = nextForm.querySelector('input[name="nonce"]');
                if (nextNonceInput) nextNonceInput.value = out.data.nextNonce;
              }
            }

            Common.MiniSPA.go(`/etc/mbrsjoin/${authMethod}/step3.do`);

          } catch (e) {
            (Common.modalShow)({
              title: '오류',
              message: e?.message || '요청 처리 중 오류가 발생했습니다.',
              buttons: 'close'
            });
          } finally {
            sending = false;
            form.classList.remove('dim');
          }
        }

        // 인증 버튼 클릭 이벤트
        document.querySelectorAll('#step2Form .auth-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const method = btn.dataset.method;
            submitStep2(document.getElementById('step2Form'), method);
          });
        });

      })();
    </script>

  </th:block>
</th:block>

</html>