<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">회원가입</h2>
              <ol class="step-box" role="list" aria-label="회원가입 단계">
                <li>
                  <div class="circle"><span>1</span><i class="icon document"></i></div>
                  <p>약관동의</p>
                </li>
                <li aria-current="step" class="active">
                  <div class="circle"><span>2</span><i class="icon lock"></i></div>
                  <p>본인인증</p>
                </li>
                <li>
                  <div class="circle"><span>3</span><i class="icon write"></i></div>
                  <p>정보입력</p>
                </li>
                <li>
                  <div class="circle"><span>4</span><i class="icon check"></i></div>
                  <p>가입완료</p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-sm">
          <div class="join-wrap">
            <form class="step-form" data-step="2" action="/etc/mbrsjoin/step2/complete">
              <!-- 서버에서 발급한 nonce 초기값 -->
              <input type="hidden" name="nonce" value="/*[[${signup.nonce}]]*/">
              <div class="gray-outer">
                <div class="step2-box" role="group" aria-label="본인인증 수단 선택">
                  <button type="button" class="auth-btn kakao" data-method="kakao">
                    <i class="icon"></i><span>카카오뱅크 인증</span>
                  </button>
                  <button type="button" class="auth-btn toss" data-method="toss">
                    <i class="icon"></i><span>토스 인증</span>
                  </button>
                  <button type="button" class="auth-btn phone" data-method="phone">
                    <i class="icon"></i><span>휴대폰 인증</span>
                  </button>
                  <button type="button" class="auth-btn ipin" data-method="ipin">
                    <i class="icon"></i><span>아이핀 인증</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>

    <script th:inline="javascript">
      (function () {
        let sending = false;

        function saveReceipt(step, receipt) {
          if (receipt) sessionStorage.setItem('rcpt' + step, receipt);
        }

        async function submitAjax(form) {
          if (sending) return;
          sending = true;

          const step = parseInt(form.getAttribute('data-step'), 10);
          const action = form.getAttribute('action');
          const payload = Object.fromEntries(new FormData(form));

          // nonce를 헤더로 전달
          const nonceInput = form.querySelector('input[name="nonce"]');
          const headers = {};
          if (nonceInput && nonceInput.value) headers['X-Nonce'] = nonceInput.value;

          // body에는 nonce 제외
          delete payload.nonce;

          try {
            const res = await Common.sendSafe(action, {
              method: 'POST',
              data: payload,
              headers: headers,
              expect: 'json',
              clientErrorMsg: '요청에 실패했습니다.',
              otherErrorMsg: '오류가 발생했습니다.'
            });

            if (!res || res.ok === false) return;

            // 영수증 저장
            saveReceipt(step, res.data.receipt || null);

            // 다음 step nonce 주입
            if (res.data.nextNonce) {
              const nextForm = document.querySelector('form[data-step="' + (step + 1) + '"]');
              if (nextForm) {
                let nextInput = nextForm.querySelector('input[name="nonce"]');
                if (!nextInput) {
                  nextInput = document.createElement('input');
                  nextInput.type = 'hidden';
                  nextInput.name = 'nonce';
                  nextForm.appendChild(nextInput);
                }
                nextInput.value = res.data.nextNonce;
              }
            }

            alert('인증 성공! 영수증: ' + res.data.receipt);

          } catch (e) {
            alert('오류 발생: ' + (e.message || '알 수 없는 오류'));
          } finally {
            sending = false;
          }
        }

        // 인증 버튼 클릭 이벤트
        document.querySelectorAll('.auth-btn').forEach(btn => {
          btn.addEventListener('click', function () {
            const form = btn.closest('form.step-form');
            if (!form) return;

            // hidden input으로 authMethod 설정
            let input = form.querySelector('input[name="authType"]');
            if (!input) {
              input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'authType';
              form.appendChild(input);
            }
            input.value = btn.getAttribute('data-method');

            // ajax 전송
            submitAjax(form);
          });
        });
      })();
    </script>

  </th:block>
</th:block>

</html>