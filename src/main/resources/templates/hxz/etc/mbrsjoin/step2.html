<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">회원가입</h2>
              <ol class="step-box" role="list" aria-label="회원가입 단계">
                <li>
                  <div class="circle"><span>1</span><i class="icon document"></i></div>
                  <p>약관동의</p>
                </li>
                <li aria-current="step" class="active">
                  <div class="circle"><span>2</span><i class="icon lock"></i></div>
                  <p>본인인증</p>
                </li>
                <li>
                  <div class="circle"><span>3</span><i class="icon write"></i></div>
                  <p>정보입력</p>
                </li>
                <li>
                  <div class="circle"><span>4</span><i class="icon check"></i></div>
                  <p>가입완료</p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-sm">
          <div class="join-wrap">
            <!-- form: step2 인증 -->
            <form id="step2Form" class="step-form" data-step="0" action="/etc/mbrsjoin/step2/complete" method="POST">
              <!-- nonce hidden -->
              <input type="hidden" name="nonce" th:value="${signup.nonce}" />

              <div class="gray-outer">
                <div class="step2-box" role="group" aria-label="본인인증 수단 선택">
                  <button type="button" class="auth-btn" data-method="kakao">
                    <i class="icon"></i>카카오뱅크 인증
                  </button>
                  <button type="button" class="auth-btn" data-method="toss">
                    <i class="icon"></i>토스 인증
                  </button>
                  <button type="button" class="auth-btn" data-method="phone">
                    <i class="icon"></i>휴대폰 인증
                  </button>
                  <button type="button" class="auth-btn" data-method="ipin">
                    <i class="icon"></i>아이핀 인증
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>

    <script th:inline="javascript">
      (function () {
        let sending = false;
        const clone = (obj) => {
          try { return structuredClone(obj); } catch { return JSON.parse(JSON.stringify(obj || {})); }
        };

        function saveReceipt(step, receipt) {
          if (receipt) sessionStorage.setItem('rcpt' + step, receipt);
        }
        function saveStepPayload(step, payload) {
          sessionStorage.setItem('step' + step, JSON.stringify(payload || {}));
        }

        const advanceUI = (doneStep) => {
          const doneForm = document.querySelector(`form.step-form[data-step="${doneStep}"]`);
          if (doneForm) {
            doneForm.classList.add('dim');
            doneForm.querySelectorAll('input,button,select,textarea').forEach(el => el.disabled = true);
          }
          const nextForm = document.querySelector(`form.step-form[data-step="${doneStep + 1}"]`);
          if (nextForm) {
            nextForm.classList.remove('dim');
            nextForm.querySelectorAll('input,button,select,textarea').forEach(el => el.disabled = false);
            nextForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        };

        async function submitStep2(form, authMethod) {
          if (sending) return;
          sending = true;
          form.classList.add('dim');
          const all = (window.Common && Common.collectFromForm)
            ? Common.collectFromForm(form)
            : Object.fromEntries(new FormData(form));
          const step = parseInt(form.getAttribute('data-step'), 10);
          const nonce = all.nonce || '';
          // const nonce = form.querySelector('input[name="nonce"]').value;
          const payload = clone(all);
          // FormData 생성
          const body = new FormData();
          body.append('authType', authMethod);
          console.log([...body.entries()]); // authType 포함 확인


          delete all.nonce;
          const headers = { 'X-Nonce': nonce }; // Content-Type 제거
          saveStepPayload(step, clone(payload));
          try {
            const out = await Common.sendSafe(
              form.getAttribute('action'),
              { method: 'POST', data: body, headers, expect: 'json' }
            );

            if (!out || out.ok === false) return;

            // 영수증 저장
            saveReceipt(step, out.data.receipt || out.data.rcpt || null);

            // 다음 nonce 주입
            if (out.data.nextNonce) {
              const nextForm = document.querySelector(`form.step-form[data-step="${step + 1}"]`);
              if (nextForm) {
                const nextNonceInput = nextForm.querySelector('input[name="nonce"]');
                if (nextNonceInput) nextNonceInput.value = out.data.nextNonce;
              }
            }

            Common.MiniSPA.go('/etc/mbrsjoin/step3.do')

          } catch (e) {
            (window.Common?.modalShow || alert)({
              title: '오류',
              message: e?.message || '요청 처리 중 오류가 발생했습니다.',
              buttons: 'close'
            });
          } finally {
            sending = false;
            form.classList.remove('dim');
          }
        }

        // 버튼 클릭 이벤트
        document.querySelectorAll('#step2Form .auth-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const method = btn.dataset.method;
            console.log('인증 방식:', method); // debug
            submitStep2(document.getElementById('step2Form'), method);
          });
        });

      })();
    </script>

  </th:block>
</th:block>

</html>