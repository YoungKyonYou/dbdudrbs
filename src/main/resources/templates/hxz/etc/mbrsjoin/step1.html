<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
    <th:block th:fragment="content">
        <main id="contents">
            <section class="section">
                <div class="container fluid">
                    <div class="join-wrap">
                        <div class="join-header">
                            <h2 class="section-title">회원가입</h2>
                            <ol class="step-box" role="list" aria-label="회원가입 단계">
                                <li aria-current="step" class="active">
                                    <div class="circle" aria-hidden="true"><span>1</span><i class="icon document"></i>
                                    </div>
                                    <p>약관동의 <span class="sr-only">(현재 단계)</span></p>
                                </li>
                                <li>
                                    <div class="circle" aria-hidden="true"><span>2</span><i class="icon lock"></i></div>
                                    <p>본인인증</p>
                                </li>
                                <li>
                                    <div class="circle" aria-hidden="true"><span>3</span><i class="icon write"></i>
                                    </div>
                                    <p>정보입력</p>
                                </li>
                                <li>
                                    <div class="circle" aria-hidden="true"><span>4</span><i class="icon check"></i>
                                    </div>
                                    <p>가입완료</p>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div class="container">
                    <div class="join-wrap">
                        <div class="line-box-wrap">
                            <!-- 약관 3개 반복 영역 -->
                            <div class="agreement" data-required="true">
                                <div class="line-box">
                                    <div class="top-box">이용약관 <span class="color-error">(필수)</span></div>
                                    <div class="bot-box scroll-y">이용약관 전문(생략)</div>
                                </div>
                                <div class="btn-wrap">
                                    <button type="button" class="btn btn-darken-line size-md disagree">동의하지 않음</button>
                                    <button type="button" class="btn btn-darkgray size-md view">약관내용 확인</button>
                                </div>
                            </div>

                            <div class="agreement" data-required="true">
                                <div class="line-box">
                                    <div class="top-box">개인정보 수집 및 이용 안내 <span class="color-error">(필수)</span></div>
                                    <div class="bot-box scroll-y">개인정보 수집 이용 전문(생략)</div>
                                </div>
                                <div class="btn-wrap">
                                    <button type="button" class="btn btn-darken-line size-md disagree">동의하지 않음</button>
                                    <button type="button" class="btn btn-darkgray size-md view">약관내용 확인</button>
                                </div>
                            </div>

                            <div class="agreement" data-required="true">
                                <div class="line-box">
                                    <div class="top-box">행정정보공동이용 사전동의 <span class="color-error">(필수)</span></div>
                                    <div class="bot-box scroll-y">행정정보 전문(생략)</div>
                                </div>
                                <div class="btn-wrap">
                                    <button type="button" class="btn btn-darken-line size-md disagree">동의하지 않음</button>
                                    <button type="button" class="btn btn-darkgray size-md view">약관내용 확인</button>
                                </div>
                            </div>
                        </div>

                        <!-- 다음 버튼 -->
                        <button type="button" class="btn btn-primary size-lg finish btn-disabled">다음</button>
                    </div>
                </div>
            </section>
        </main>

        <script th:inline="javascript">
            (function () {
                const agreements = document.querySelectorAll('.agreement');
                const nextBtn = document.querySelector('.finish');

                agreements.forEach((ag, idx) => {
                    const viewBtn = ag.querySelector('.view');
                    const disagreeBtn = ag.querySelector('.disagree');
                    ag.dataset.agreed = "false";

                    // 동의 버튼 클릭
                    viewBtn.addEventListener('click', () => {
                        viewBtn.textContent = '동의';
                        viewBtn.classList.replace('btn-darkgray', 'btn-primary');
                        disagreeBtn.classList.replace('btn-warning', 'btn-darken-line');
                        ag.dataset.agreed = "true";
                        saveAgreement(idx, true);
                        updateNextBtn();
                    });

                    // 동의하지 않음 버튼 클릭
                    disagreeBtn.addEventListener('click', () => {
                        viewBtn.textContent = '약관내용 확인';
                        viewBtn.classList.replace('btn-primary', 'btn-darkgray');
                        disagreeBtn.classList.replace('btn-darken-line', 'btn-warning');
                        ag.dataset.agreed = "false";
                        saveAgreement(idx, false);
                        updateNextBtn();
                    });
                });

                // 동의 상태 sessionStorage 저장
                function saveAgreement(idx, agreed) {
                    // idx 기준: 0=이용약관, 1=개인정보, 2=행정정보
                    if (idx === 0) {
                        sessionStorage.setItem('mrkgUtlzAgrmYn', agreed ? 'Y' : 'N');
                    } else if (idx === 1) {
                        sessionStorage.setItem('smsRcvAgrmYn', agreed ? 'Y' : 'N');
                    } else if (idx === 2) {
                        sessionStorage.setItem('mailRcvAgrmYn', agreed ? 'Y' : 'N');
                    }
                }

                function updateNextBtn() {
                    const allAgreed = Array.from(agreements).every(ag => ag.dataset.agreed === "true");
                    if (allAgreed) nextBtn.classList.remove('btn-disabled');
                    else nextBtn.classList.add('btn-disabled');
                }

                nextBtn.addEventListener('click', async () => {
                    const notAgreed = Array.from(agreements).filter(ag => ag.dataset.agreed !== "true");
                    if (notAgreed.length > 0) {
                        const titles = notAgreed.map(ag => ag.querySelector('.top-box').textContent.trim());
                        alert(`${titles.join(', ')}에 대한 확인 및 동의를 진행해 주세요.`);
                        return;
                    }

                    try {
                        const res = await fetch('/etc/mbrsjoin/start', {
                            method: 'GET',
                            credentials: 'include'  // 쿠키 포함
                        });

                        if (!res.ok) throw new Error(`Step2 진입 실패: ${res.status}`);

                        // Step2 페이지로 이동
                        window.location.href = '/etc/mbrsjoin/step2.do';
                    } catch (err) {
                        alert(err.message);
                    }
                });

            })();
        </script>


    </th:block>
</th:block>

</html>