<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">
    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">회원가입</h2>
              <ol class="step-box" role="list" aria-label="회원가입 단계">
                <li>
                  <div class="circle" aria-hidden="true">
                    <span>1</span>
                    <i class="icon document"></i>
                  </div>
                  <p>약관동의</p>
                </li>
                <li>
                  <div class="circle" aria-hidden="true">
                    <span>2</span>
                    <i class="icon lock"></i>
                  </div>
                  <p>본인인증</p>
                </li>
                <li>
                  <div class="circle" aria-hidden="true">
                    <span>3</span>
                    <i class="icon write"></i>
                  </div>
                  <p>정보입력</p>
                </li>
                <li aria-current="step" class="active">
                  <div class="circle" aria-hidden="true">
                    <span>4</span>
                    <i class="icon check"></i>
                  </div>
                  <p>가입완료 <span class="sr-only">(현재 단계)</span></p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-sm">
          <div class="join-wrap">
            <div class="fin-box">
              <div class="gray-outer">
                <div class="step4-box" role="status" aria-live="polite">
                  <p class="complete-msg">
                    <span>회원가입이 완료되었습니다.</span>
                  </p>

                  <div class="btn-wrap">
                    <a href="" class="btn btn-primary size-lg" id="supportBtn" role="button">
                      지원 사업 가입하기
                    </a>
                    <a onclick="Common.MiniSPA.go('/etc/lgn/login.do')" class="btn btn-darken-link size-lg"
                      role="button">
                      로그인
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      (async function () {
        // Step3 완료 후 rcpt3가 없는 경우 다시 Step3로 이동
        const rcpt3 = sessionStorage.getItem('rcpt3');
        const step3Data = sessionStorage.getItem('step3');

        if (!rcpt3 || !step3Data) {
          alert('Step3 정보가 누락되었습니다. Step3부터 다시 진행해주세요.');
          window.location.href = '/etc/mbrsjoin/step3.do';
          return;
        }

        // Step4 최종 token 전송
        async function sendStep4() {
          try {
            const res = await fetch('/etc/mbrsjoin/step4/complete', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Final-Token': rcpt3 // 서버에서 요구하는 final token
              },
              body: JSON.stringify({}),
              credentials: 'include'
            });

            if (!res.ok) throw new Error(`서버 오류: ${res.status}`);
            const data = await res.json();

            console.log('Step4 완료:', data);
          } catch (err) {
            alert(`Step4 요청 실패: ${err.message}`);
            window.location.href = '/etc/mbrsjoin/step3.do';
          }
        }

        // Step4 요청
        await sendStep4();

        // 지원사업 버튼 클릭 시 이동 (예시)
        document.getElementById('supportBtn').addEventListener('click', function (e) {
          e.preventDefault();
          // Step4 완료 후 서버에서 전달 받은 값에 따라 링크를 변경 가능
          Common.MiniSPA.go('/etc/support/registration.do');
        });

      })();
    </script>

  </th:block>
</th:block>

</html>