<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">
    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">회원가입</h2>
              <ol class="step-box" role="list" aria-label="회원가입 단계">
                <li>
                  <div class="circle" aria-hidden="true">
                    <span>1</span><i class="icon document"></i>
                  </div>
                  <p>약관동의</p>
                </li>
                <li>
                  <div class="circle" aria-hidden="true">
                    <span>2</span><i class="icon lock"></i>
                  </div>
                  <p>본인인증</p>
                </li>
                <li>
                  <div class="circle" aria-hidden="true">
                    <span>3</span><i class="icon write"></i>
                  </div>
                  <p>정보입력</p>
                </li>
                <li aria-current="step" class="active">
                  <div class="circle" aria-hidden="true">
                    <span>4</span><i class="icon check"></i>
                  </div>
                  <p>가입완료 <span class="sr-only">(현재 단계)</span></p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-sm">
          <div class="join-wrap">
            <div class="fin-box">
              <div class="gray-outer">
                <div class="step4-box" role="status" aria-live="polite">
                  <p class="complete-msg">
                    <span>회원가입이 완료되었습니다.</span>
                  </p>

                  <div class="btn-wrap">
                    <a href="#" class="btn btn-primary size-lg" id="supportBtn" role="button">
                      지원 사업 가입하기
                    </a>
                    <a onclick="Common.MiniSPA.go('/etc/lgn/login.do')" class="btn btn-darken-link size-lg"
                      role="button">
                      로그인
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script th:inline="javascript">
      (async function () {
        try {
          // ✅ 쿠키에서 최종 토큰 확인
          const finalToken = (document.cookie.match(/(^|;)\s*onb_done=([^;]+)/)?.[2]) || null;

          // ✅ 서버에 완료 알림 (단순히 검증 + 세션 정리용)
          const res = await fetch('/etc/mbrsjoin/step4.do', {
            method: 'GET',
            credentials: 'include'
          });

          if (!res.ok) {
            let msg = '서버 오류가 발생했습니다.';
            if (res.status === 403) msg = '토큰이 없거나 만료되었습니다.';
            if (res.status === 409) msg = '이미 완료된 가입입니다.';
            (window.Common?.modalShow || alert)({ title: '안내', message: msg, buttons: 'close' });

            Common.MiniSPA.go(`/etc/mbrsjoin/step3.do`)
            return;
          }
          sessionStorage.clear();
          // ✅ 완료 후 버튼 활성화
          document.getElementById('supportBtn')?.addEventListener('click', function (e) {
            e.preventDefault();
            Common.MiniSPA.go('/spfnapl/rsdcAuth.do');
          });

        } catch (err) {
          console.error(err);
          (Common.modalShow || alert)({
            title: '오류',
            message: `Step4 요청 실패: ${err.message}`,
            buttons: 'close'
          });
          // window.location.href = '/etc/mbrsjoin/step3.do';
        }
      })();
    </script>
  </th:block>
</th:block>

</html>