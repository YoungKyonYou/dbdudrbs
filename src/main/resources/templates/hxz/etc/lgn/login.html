<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container size-xsm">
          <div class="login-wrap">
            <div class="login-header">
              <h2 class="section-title">로그인</h2>
              <p>교통비지원 통합포털에 오신 것을 환영합니다.</p>
              <p>로그인 후 다양한 교통비 지원 혜택을 받아보세요.</p>
            </div>
            <div class="form-box">
              <form action="" method="post" novalidate>
                <!-- 아이디 -->
                <div>
                  <p class="field-title">아이디</p>
                  <label class="sr-only" for="userId">아이디</label>
                  <input id="userId" name="userId" type="text" class="text-field size-lg" placeholder="아이디를 입력해주세요."
                    autocomplete="username" required aria-required="true" minlength="6" maxlength="15"
                    pattern="^[a-z][a-z0-9._]{5,14}$" aria-describedby="userIdHelp">
                  <!-- aria-describedby가 가리키는 도움말 최소 제공 -->
                  <p id="userIdHelp" class="sr-only">영문 소문자 시작, 소문자/숫자/._ 조합 6~15자</p>
                </div>

                <!-- 비밀번호 -->
                <div>
                  <p class="field-title">비밀번호</p>
                  <label class="sr-only" for="password">비밀번호</label>
                  <input id="password" name="password" type="password" class="text-field size-lg"
                    placeholder="비밀번호를 입력해주세요." autocomplete="current-password" required aria-required="true"
                    minlength="8" maxlength="20" aria-describedby="pwdHelp1 pwdHelp2">
                  <p id="pwdHelp1" class="sr-only">최소 8자 이상</p>
                  <p id="pwdHelp2" class="sr-only">숫자/특수문자 포함 권장</p>
                </div>

                <div class="find">
                  <a href="">아이디 찾기</a>
                  <a href="">비밀번호 찾기</a>
                </div>

                <div class="catpcha-box">
                  <label for="captchaInput" class="sr-only">자동입력 방지문자</label>
                  <div class="flex">
                    <img src="/images/sub/img-catpcha.jpg" alt="">
                    <button type="button" class="btn btn-icon-left" aria-label="캡차 새로고침">
                      <i class="icon icon-refresh"></i>새로고침
                    </button>
                  </div>
                </div>

                <input id="captchaInput" name="captcha" type="text" class="text-field size-lg"
                  placeholder="자동입력 방지문자를 입력해주세요." required aria-required="true">

                <button type="submit" class="btn btn-primary btn-icon-right size-lg">
                  <i class="icon icon-enter"></i>로그인
                </button>

                <div class="flex gap8 guide-text">
                  <span>아직 교통비지원 통합포털 회원이 아니신가요?</span>
                  <a href="" class="color-primary underline">회원가입</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

    </main>
    <script th:inline="javascript">
      (function () {
        /** ─────────────────────────────────────────────
         *  공통 셀렉터 함수 정의
         *  ───────────────────────────────────────────── */
        const $ = (sel, el = document) => el.querySelector(sel);

        /** ─────────────────────────────────────────────
         *  서버 응답(response) 처리
         *  ───────────────────────────────────────────── */
        const res = /*[[${response}]]*/ null;

        if (res) {
          if (res.code === 'LOGIN_TAKEOVER') {
            // 중복 로그인(다른 세션이 접속 중)
            Common.modalShow({
              message: res.message,
              title: '알림',
              buttons: 'ok-close',
              onOk: takeover // takeover 함수 실행
            });
          } else if (res.message) {
            // 일반 알림 메시지
            Common.modalShow({
              message: res.message,
              title: '알림',
              buttons: 'close'
            });
          }
        }

        /** ─────────────────────────────────────────────
         *  takeover: 기존 세션 접속 해제 및 새 로그인 시도
         *  ───────────────────────────────────────────── */
        async function takeover() {
          const res = await fetch("/auth/takeover", { method: 'POST' });
          if (res && res.ok) {
            window.location.href = '/page/dashboard/index';
          }
        }

        /** ─────────────────────────────────────────────
         *  요소 캐싱
         *  ───────────────────────────────────────────── */
        const btnLogin = $('.btn.btn-login');
        const inputs = document.querySelectorAll('.login-wrap .text-field');
        const inputId = inputs?.[0];  // 아이디 입력창
        const inputPw = inputs?.[1];  // 비밀번호 입력창

        if (!btnLogin || !inputId || !inputPw) return;



        /** ─────────────────────────────────────────────
         *  submitNativeLogin:
         *  숨은 폼을 만들어 /login 으로 직접 제출
         *  ───────────────────────────────────────────── */
        const submitNativeLogin = (username, password) => {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/login';
          form.style.display = 'none';

          const hid = (name, value) => {
            const i = document.createElement('input');
            i.type = 'hidden';
            i.name = name;
            i.value = value;
            return i;
          };

          // 아이디 / 비밀번호 필드 추가
          form.appendChild(hid('username', username));
          form.appendChild(hid('password', password));

          // (선택) 로그인 유지 체크박스가 있다면 추가
          // form.appendChild(hid('remember-me', 'on'));

          document.body.appendChild(form);
          form.submit(); // Spring Security 기본 처리 (성공 → redirect, 실패 → /login?error)
        };

        /** ─────────────────────────────────────────────
         *  doLogin: 로그인 시도 함수
         *  ───────────────────────────────────────────── */
        const doLogin = () => {
          const username = (inputId.value || '').trim();
          const password = inputPw.value || '';
          if (!username || !password) {
            // 입력값 누락 시 알림
            alert('아이디와 비밀번호를 입력해 주세요.');
            return;
          }
          submitNativeLogin(username, password);
        };

        /** ─────────────────────────────────────────────
         *  버튼 클릭 이벤트
         *  ───────────────────────────────────────────── */
        btnLogin.addEventListener('click', (e) => {
          e.preventDefault();
          doLogin();
        });

        /** ─────────────────────────────────────────────
         *  엔터 키로 로그인
         *  ───────────────────────────────────────────── */
        [inputId, inputPw].forEach(el => el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            doLogin();
          }
        }));
      })()
    </script>

  </th:block>
</th:block>

</html>