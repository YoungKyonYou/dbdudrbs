<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container size-xsm">
          <div class="login-wrap">
            <div class="login-header">
              <h2 class="section-title">로그인</h2>
              <p>교통비지원 통합포털에 오신 것을 환영합니다.</p>
              <p>로그인 후 다양한 교통비 지원 혜택을 받아보세요.</p>
            </div>

            <div class="form-box">
              <form id="loginForm" action="" method="post" novalidate>
                <!-- 아이디 -->
                <div>
                  <p class="field-title">아이디</p>
                  <label class="sr-only" for="userId">아이디</label>
                  <input id="userId" name="userId" type="text" class="text-field size-lg" placeholder="아이디를 입력해주세요."
                    autocomplete="username" required aria-required="true" minlength="6" maxlength="15"
                    pattern="^[a-z][a-z0-9._]{5,14}$" aria-describedby="userIdHelp">
                  <p id="userIdHelp" class="sr-only">영문 소문자 시작, 소문자/숫자/._ 조합 6~15자</p>
                </div>

                <!-- 비밀번호 -->
                <div>
                  <p class="field-title">비밀번호</p>
                  <label class="sr-only" for="password">비밀번호</label>
                  <input id="password" name="password" type="password" class="text-field size-lg"
                    placeholder="비밀번호를 입력해주세요." autocomplete="current-password" required aria-required="true"
                    minlength="8" maxlength="20" aria-describedby="pwdHelp1 pwdHelp2">
                  <p id="pwdHelp1" class="sr-only">최소 8자 이상</p>
                  <p id="pwdHelp2" class="sr-only">숫자/특수문자 포함 권장</p>
                </div>

                <div class="find">
                  <a href="">아이디 찾기</a>
                  <a href="">비밀번호 찾기</a>
                </div>

                <!-- ✅ CAPTCHA 영역 -->
                <div class="captcha-box">
                  <p class="field-title">자동입력 방지문자</p>
                  <div class="flex gap8 items-center">
                    <img id="captchaImage" th:src="@{/readCaptchaImage.do}" alt="보안문자 이미지"
                      style="border: 1px solid #ccc; border-radius: 4px;">
                    <button type="button" id="btnCaptchaRefresh" class="btn btn-icon-left" aria-label="캡차 새로고침">
                      <i class="icon icon-refresh"></i>새로고침
                    </button>
                  </div>
                  <input id="captchaInput" name="captcha" type="text" class="text-field size-lg mt-2"
                    placeholder="위 문자를 입력해주세요." required aria-required="true">
                </div>

                <button type="submit" class="btn btn-primary btn-icon-right size-lg btn-login">
                  <i class="icon icon-enter"></i>로그인
                </button>

                <div class="flex gap8 guide-text">
                  <span>아직 교통비지원 통합포털 회원이 아니신가요?</span>
                  <a href="" class="color-primary underline">회원가입</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script th:inline="javascript">
      (function () {
        /** 공통 셀렉터 */
        const $ = (sel, el = document) => el.querySelector(sel);

        /** 서버 응답 처리 */
        const res = /*[[${response}]]*/ null;
        if (res) {
          if (res.code === 'LOGIN_TAKEOVER') {
            Common.modalShow({
              message: res.message,
              title: '알림',
              buttons: 'ok-close',
              onOk: takeover
            });
          } else if (res.message) {
            Common.modalShow({
              message: res.message,
              title: '알림',
              buttons: 'close'
            });
          }
        }

        /** 기존 세션 종료 후 재로그인 */
        async function takeover() {
          const res = await fetch("/auth/takeover", { method: 'POST' });
          if (res && res.ok) {
            window.location.href = '/page/dashboard/index';
          }
        }

        const btnLogin = $('.btn-login');
        const inputId = $('#userId');
        const inputPw = $('#password');
        const captchaImg = $('#captchaImage');
        const btnCaptchaRefresh = $('#btnCaptchaRefresh');

        if (!btnLogin || !inputId || !inputPw) return;

        /** ✅ 캡차 새로고침 */
        btnCaptchaRefresh.addEventListener('click', () => {
          captchaImg.src = '/readCaptchaImage.do?' + new Date().getTime();
        });

        /** 폼 제출 (기존 방식 유지) */
        const submitNativeLogin = (username, password, captcha) => {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/login';
          form.style.display = 'none';
          const hid = (name, value) => {
            const i = document.createElement('input');
            i.type = 'hidden';
            i.name = name;
            i.value = value;
            return i;
          };
          form.appendChild(hid('username', username));
          form.appendChild(hid('password', password));
          form.appendChild(hid('captcha', captcha)); // ✅ 캡차 추가
          document.body.appendChild(form);
          form.submit();
        };

        /** 로그인 처리 */
        const doLogin = () => {
          const username = (inputId.value || '').trim();
          const password = inputPw.value || '';
          const captcha = ($('#captchaInput')?.value || '').trim();

          if (!username || !password || !captcha) {
            alert('아이디, 비밀번호, 자동입력 방지문자를 모두 입력해주세요.');
            return;
          }

          submitNativeLogin(username, password, captcha);
        };

        btnLogin.addEventListener('click', (e) => {
          e.preventDefault();
          doLogin();
        });

        [inputId, inputPw].forEach(el => el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            doLogin();
          }
        }));
      })()
    </script>
  </th:block>
</th:block>

</html>