<!-- component/pagination.html -->
<nav id="pager" class="pagination" aria-label="페이지네이션" th:fragment="pager(pageData)"
     th:if="${pageData != null}"
     th:with="
        current        = ${pageData.page},
        totalPages     = ${pageData.totalPages},
        totalPagesInt  = ${T(java.lang.Math).toIntExact(totalPages)},
        blockIdx       = ${current / 10},
        blockStart     = ${blockIdx * 10},
        blockEnd       = ${T(java.lang.Math).min(blockStart + 9, totalPagesInt - 1)}
     ">

    <ul class="pagination-list" role="list">
        <!-- 처음 -->
        <li class="page-ctrl">
            <a class="page-btn" href="#" aria-label="첫 페이지"
               th:attr="data-page=${0}"
               th:attrappend="aria-disabled=${!pageData.hasPrev} ? 'true' : null,
                        tabindex=${!pageData.hasPrev} ? '-1' : null">
                <i class="icon icon-arrow-left-end" aria-hidden="true"></i>
            </a>
        </li>

        <!-- 이전 -->
        <li class="page-ctrl">
            <a class="page-btn" href="#" aria-label="이전 페이지"
               th:attr="data-page=${pageData.page - 1}"
               th:attrappend="aria-disabled=${!pageData.hasPrev} ? 'true' : null,
                        tabindex=${!pageData.hasPrev} ? '-1' : null">
                <i class="icon icon-arrow-left" aria-hidden="true"></i>
            </a>
        </li>

        <!-- 숫자 -->
        <li class="page-num"
            th:each="i : ${#numbers.sequence(blockStart, blockEnd)}"
            th:classappend="${i == pageData.page} ? ' is-current'">
            <!-- 현재 페이지 -->
            <span th:if="${i == pageData.page}"
                  th:text="${i + 1}"
                  aria-current="page">1</span>

            <!-- 다른 페이지 -->
            <a th:if="${i != pageData.page}"
               href="#"
               th:text="${i + 1}"
               th:attr="data-page=${i}"
               th:aria-label="${i + 1} + '페이지'">1</a>
        </li>

        <!-- 다음 -->
        <li class="page-ctrl">
            <a class="page-btn" href="#" aria-label="다음 페이지"
               th:attr="data-page=${pageData.page + 1}"
               th:attrappend="aria-disabled=${!pageData.hasNext} ? 'true' : null,
                        tabindex=${!pageData.hasNext} ? '-1' : null">
                <i class="icon icon-arrow-right" aria-hidden="true"></i>
            </a>
        </li>

        <!-- 마지막 -->
        <li class="page-ctrl" th:with="tp=${T(java.lang.Math).toIntExact(pageData.totalPages)}">
            <a class="page-btn" href="#" aria-label="마지막 페이지"
               th:attr="data-page=${tp > 0 ? tp - 1 : 0}"
               th:attrappend="aria-disabled=${!pageData.hasNext} ? 'true' : null,
                        tabindex=${!pageData.hasNext} ? '-1' : null">
                <i class="icon icon-arrow-right-end" aria-hidden="true"></i>
            </a>
        </li>
    </ul>

    <script>
        // ===== 너가 쓰던 유틸 유지 =====
        function putParam(params, key, value) {
          if (value === null || value === undefined || value === '') return;
          if (Array.isArray(value)) value.forEach(v => putParam(params, key, v));
          else params.set(key, value);
        }

        async function fetchAndSwap(u) {
          const res = await fetch(u.toString(), { headers: { 'X-Requested-With': 'fetch' } });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const html = await res.text();

          const doc = new DOMParser().parseFromString(html, 'text/html');
          const newTbody = doc.querySelector('#grid-tbody');
          const newPager = doc.querySelector('#pager');

          const curTbody = document.querySelector('#grid-tbody');
          const curPager = document.querySelector('#pager');

          if (newTbody && curTbody) curTbody.replaceWith(newTbody);
          if (newPager && curPager) curPager.innerHTML = newPager.innerHTML;

          history.pushState(null, '', u.toString());
        }

        // ===== bindPagination 그대로 (퍼블리셔 셀렉터에 맞춤) =====
        function bindPagination(url, ...args) {
          const baseUrl  = new URL(url, window.location.origin);
          const baseArgs = Object.assign({}, ...args);

          window.addEventListener('popstate', () => {
            fetchAndSwap(new URL(window.location.href)).catch(console.error);
          });

          document.addEventListener('click', function (e) {
            const btn = e.target.closest('.pagination a[data-page]');
            if (!btn) return;

            // aria-disabled 또는 disabled 클래스 대응
            if (btn.getAttribute('aria-disabled') === 'true' || btn.classList.contains('disabled')) return;

            e.preventDefault();

            const page = Number(btn.dataset.page);
            if (Number.isNaN(page)) return;

            const u = new URL(baseUrl.toString());
            const p = new URLSearchParams(u.search);

            const size = baseArgs.size ?? null;   // null이면 생략
            const dir  = baseArgs.dir  ?? 'asc';
            const sort = baseArgs.sort ?? null;

            putParam(p, 'size', size);
            putParam(p, 'page', page); // 0-base
            putParam(p, 'dir',  dir);
            if (sort !== null && sort !== undefined && sort !== '') putParam(p, 'sort', sort);

            const skip = new Set(['size','page','dir','sort']);
            Object.entries(baseArgs).forEach(([k,v]) => { if (!skip.has(k)) putParam(p, k, v); });

            u.search = p.toString();
            fetchAndSwap(u).catch(console.error);
          });
        }
    </script>
</nav>
