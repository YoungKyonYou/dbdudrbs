<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/header :: layout(~{::content})}">
  <th:block th:fragment="content">

    <main id="contents">
      <section class="section">
        <div class="container fluid">
          <div class="join-wrap">
            <div class="join-header">
              <h2 class="section-title">회원가입</h2>
              <ol class="step-box" role="list" aria-label="회원가입 단계">
                <li>
                  <div class="circle" aria-hidden="true"><span>1</span><i class="icon document"></i></div>
                  <p>약관동의</p>
                </li>
                <li>
                  <div class="circle" aria-hidden="true"><span>2</span><i class="icon lock"></i></div>
                  <p>본인인증</p>
                </li>
                <li aria-current="step" class="active">
                  <div class="circle" aria-hidden="true"><span>3</span><i class="icon write"></i></div>
                  <p>정보입력 <span class="sr-only">(현재 단계)</span></p>
                </li>
                <li>
                  <div class="circle" aria-hidden="true"><span>4</span><i class="icon check"></i></div>
                  <p>가입완료</p>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="container size-xsm">
          <div class="join-wrap">
            <div class="form-box">
              <form id="step3Form" action="" method="post" novalidate>
                <!-- 아이디 -->
                <div>
                  <label class="field-title" for="userId">아이디 <span class="color-error">*</span></label>
                  <input id="userId" name="userId" type="text" class="text-field size-lg" placeholder="아이디를 입력해주세요."
                    required minlength="6" maxlength="15" pattern="^[a-z][a-z0-9._]{5,14}$">
                </div>

                <!-- 비밀번호 -->
                <div>
                  <label class="field-title" for="password">비밀번호 <span class="color-error">*</span></label>
                  <input id="password" name="password" type="password" class="text-field size-lg"
                    placeholder="비밀번호를 입력해주세요." required minlength="8" maxlength="20">
                  <p class="guide-text">※ 영문, 숫자, 특수문자 중 2가지 이상 혼합 8~20자 (영문자 필수)</p>
                  <p class="guide-text">※ 아이디가 포함된 비밀번호는 사용할 수 없습니다.</p>
                </div>

                <!-- 비밀번호 확인 -->
                <div>
                  <label class="field-title" for="passwordConfirm">비밀번호 확인 <span class="color-error">*</span></label>
                  <input id="passwordConfirm" name="passwordConfirm" type="password" class="text-field size-lg"
                    placeholder="비밀번호를 다시 입력해주세요." required>
                </div>

                <!-- 휴대전화번호 -->
                <div>
                  <p class="field-title">휴대전화번호 <span class="color-error">*</span></p>
                  <fieldset>
                    <div class="flex align-center gap8">
                      <input id="mobile1" name="mobile1" type="text" value="010" readonly>
                      <span class="flex-bar">-</span>
                      <input id="mobile2" name="mobile2" type="text" value="1234" readonly>
                      <span class="flex-bar">-</span>
                      <input id="mobile3" name="mobile3" type="text" value="5678" readonly>
                    </div>
                  </fieldset>
                </div>

                <!-- 제출 -->
                <button type="submit" class="btn btn-primary btn-icon-right size-lg">
                  <i class="icon icon-finish" aria-hidden="true"></i> 완료
                </button>
              </form>
            </div>
          </div>
        </div>

      </section>
    </main>

    <script>
      (function () {
        const form = document.getElementById('step3Form');
        if (!form) return;

        form.addEventListener('submit', async function (event) {
          event.preventDefault();

          try {
            const receipt = sessionStorage.getItem('rcpt2');
            const nonce = sessionStorage.getItem('step2Nonce');

            if (!receipt || !nonce) {
              throw new Error('본인인증 데이터가 없습니다. 이전 단계로 돌아가세요.');
            }

            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());

            const res = await fetch('/etc/mbrsjoin/step3/submit', {
              method: 'POST',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json',
                'X-Nonce': nonce
              },
              body: JSON.stringify({
                ...payload,
                rcpt2: receipt
              })
            });

            if (!res.ok) throw new Error('정보 입력 제출 실패');

            // Step4(가입 완료) 페이지로 이동
            window.location.href = '/etc/mbrsjoin/step4.do';
          } catch (err) {
            alert(err.message);
          }
        });
      })();
    </script>

  </th:block>
</th:block>

</html>